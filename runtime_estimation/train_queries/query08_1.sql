



select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '72719','60772','57759','43820','93234','16272',
                          '12766','46855','33696','76118','39224',
                          '10843','57089','65135','57530','60294',
                          '12510','24300','94226','56402','37030',
                          '30176','90937','69949','67796','72789',
                          '21063','41422','62179','30992','61865',
                          '34534','84915','74852','91842','48066',
                          '84989','85259','20761','54996','81693',
                          '64792','13300','18793','11581','92599',
                          '51778','86483','64163','38837','22968',
                          '50891','42037','81874','44283','40169',
                          '16327','49210','10939','51005','75183',
                          '87417','71783','62387','82278','27683',
                          '23553','38025','81979','78911','41602',
                          '33323','94883','53342','28259','36120',
                          '82101','21220','13559','41414','96881',
                          '20102','11456','43954','31004','91277',
                          '86650','92549','42308','31929','24959',
                          '26661','75062','82489','43876','11865',
                          '56493','80613','81094','61463','31395',
                          '33499','88472','66886','76021','18871',
                          '11074','78525','11711','44766','95217',
                          '38241','15277','50262','25300','40914',
                          '19616','15772','41333','42004','87501',
                          '56574','68328','11426','24353','44847',
                          '14532','82677','97453','13852','52008',
                          '29776','65190','43557','11400','73025',
                          '21633','23819','31100','30667','41277',
                          '38712','35002','11404','99461','64263',
                          '85052','72486','15879','45186','70470',
                          '24624','91603','23247','16853','53616',
                          '18797','65259','42807','22585','74164',
                          '14057','45091','36905','71584','78472',
                          '48779','80369','11752','37281','36117',
                          '36110','72631','15159','81083','25601',
                          '97178','35161','25050','14487','15791',
                          '14870','92082','43437','77788','97420',
                          '36634','56192','88111','62408','19715',
                          '72041','40106','39097','85371','33695',
                          '26706','76088','60962','87709','92050',
                          '68077','16609','77701','15267','19612',
                          '10818','59425','96364','25077','10141',
                          '11372','82885','84226','98060','14621',
                          '52830','90414','84568','35781','13935',
                          '24103','46552','11620','18884','70582',
                          '11954','15079','37914','46893','85452',
                          '42348','56360','78986','89731','66155',
                          '41396','73872','43390','90645','16572',
                          '22127','58111','61656','40333','22334',
                          '40954','91480','54463','83847','19516',
                          '76338','81098','88951','84630','30996',
                          '16579','69468','28230','38574','55924',
                          '22483','27069','93219','37962','22045',
                          '46259','13365','60872','80602','81482',
                          '39431','94121','71760','37570','65901',
                          '27731','25312','39612','66424','70667',
                          '90135','88084','52568','75532','74330',
                          '32394','76606','84605','22299','77789',
                          '60822','43613','28625','45287','49718',
                          '34111','32290','73118','37913','68589',
                          '52391','26961','45900','22771','83940',
                          '35071','90050','72442','30034','27487',
                          '19402','56101','14934','16670','89076',
                          '49188','63156','15650','43653','51100',
                          '80783','36464','84146','96147','37341',
                          '52453','17798','22054','30610','22962',
                          '21369','63233','24712','27150','10541',
                          '10985','42208','10824','15515','65395',
                          '39244','63794','43237','13143','23766',
                          '81764','44943','67598','22855','33087',
                          '92714','72460','66745','25583','91008',
                          '55658','20139','62765','22163','97473',
                          '48162','86632','11669','95892','82066',
                          '93051','24085','26210','88520','31749',
                          '37107','12348','27852','14835','60775',
                          '43994','13818','60502','33453','52682',
                          '11582','33992','49875','67757','57792',
                          '20592','86502','62578','95233','35802',
                          '44333','20842','73862','18549','48387',
                          '23885','50823','47930','61782')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100