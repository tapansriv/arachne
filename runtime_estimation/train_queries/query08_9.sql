



select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '17357','75910','17053','77246','85755','94414',
                          '83868','45712','36113','58576','17340',
                          '87330','96939','45234','20289','18787',
                          '54525','66151','53300','36750','72209',
                          '47721','33309','86953','16405','49184',
                          '33794','23850','89002','37713','55271',
                          '35295','28072','90740','63196','53619',
                          '85969','33011','92710','24434','57047',
                          '48545','26750','53146','98850','32282',
                          '20597','94399','30319','56715','45275',
                          '85122','66670','73297','66442','56407',
                          '22061','43733','38853','24621','44889',
                          '16909','14171','56490','74651','29231',
                          '53391','36059','81437','73001','16392',
                          '27555','50245','74208','94771','29008',
                          '68956','91037','81002','50018','72056',
                          '72941','52376','97009','75843','55542',
                          '94560','44496','80539','43198','64257',
                          '71849','39245','45728','24596','58879',
                          '75138','37962','78424','32389','46508',
                          '40517','10601','77129','66446','27608',
                          '29831','40962','90466','21661','51784',
                          '88056','31305','40266','92097','98933',
                          '45761','32041','82531','67187','58669',
                          '20041','30005','46388','67279','16345',
                          '24542','18944','28579','73679','56404',
                          '91877','65677','36689','18825','16159',
                          '63962','55816','41798','14245','57517',
                          '78953','93653','66500','33186','66881',
                          '60749','85319','43170','58737','14765',
                          '91348','63274','68044','93562','36471',
                          '34672','49834','71718','48899','11917',
                          '88657','68999','58020','67806','95924',
                          '30503','80068','94094','11998','94884',
                          '13034','94346','71889','74136','52960',
                          '89242','36141','79094','50169','19850',
                          '37483','30863','76382','44143','81134',
                          '50736','67229','95470','62677','77035',
                          '56571','25466','72015','80590','87588',
                          '42974','63193','70215','44632','94275',
                          '49951','56527','85891','45122','16774',
                          '15728','46563','67080','37014','46005',
                          '25854','99288','55475','97736','60708',
                          '47919','46468','18178','97473','32701',
                          '95944','48209','13343','32494','37547',
                          '74182','77391','76834','76995','42095',
                          '76203','89455','58659','26203','51930',
                          '19540','27496','72433','23470','17483',
                          '43251','19824','37075','32503','39414',
                          '19966','83608','75791','95152','12351',
                          '22543','78579','29543','72356','63129',
                          '40429','41596','69609','67270','70396',
                          '27361','93417','54998','56678','85769',
                          '23301','29737','10802','47353','55289',
                          '85764','30566','39740','53346','89665',
                          '79336','31213','21314','20449','85720',
                          '34063','16347','40500','61732','97873',
                          '34879','55290','60344','33724','11784',
                          '70609','26641','55154','85139','85424',
                          '21704','15226','13605','88745','72894',
                          '61539','56309','92064','40847','38448',
                          '91176','51373','94591','13281','59907',
                          '15127','41393','17018','33963','36631',
                          '77741','39560','72118','24810','96468',
                          '48850','78109','29121','49563','14100',
                          '29419','96106','66463','77664','59480',
                          '65859','82930','48638','80504','69097',
                          '17726','74920','47855','35712','36302',
                          '68872','94715','95051','15087','43083',
                          '83597','88058','87128','19420','32717',
                          '32331','93049','96699','86998','75803',
                          '67967','39662','51555','34579','70687',
                          '64654','42220','22490','53815','60456',
                          '24435','38631','85436','82611','63267',
                          '75558','42193','69030','61658','24881',
                          '58965','52710','62700','48243','21401',
                          '53085','12287','23559','99238','96004',
                          '51687','35694','78148','59876','86518',
                          '67308','27818','87323','31502','57026',
                          '44543','10651','58809','23012')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100