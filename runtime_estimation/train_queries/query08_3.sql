



select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '12484','77866','88871','87541','33192','14939',
                          '54600','69539','28687','68440','50674',
                          '34401','79489','66057','78508','70482',
                          '46625','34978','50246','19263','21813',
                          '66172','15299','11590','20306','96903',
                          '57998','56600','81822','37935','38797',
                          '56736','93080','85988','86928','38155',
                          '82797','94799','62634','24200','23087',
                          '18940','29806','82942','47975','49857',
                          '95428','14202','61597','73678','32352',
                          '45345','32573','38333','61767','77156',
                          '54025','99788','84393','61899','48787',
                          '89020','83664','10136','51864','74649',
                          '37743','47261','39245','61873','55044',
                          '70853','78344','22570','49116','67492',
                          '81460','92913','99988','27926','65740',
                          '61642','72077','67944','54112','27245',
                          '85315','11020','92676','17262','21148',
                          '28147','10219','92950','73037','14693',
                          '47328','45931','29080','47011','71650',
                          '42225','92502','63591','59244','42025',
                          '43956','62193','51388','21337','80081',
                          '20464','78723','95279','43039','66063',
                          '44714','97619','85897','32244','36307',
                          '85140','56640','60736','59860','60121',
                          '25925','82475','92139','45205','95899',
                          '38828','45370','54020','59168','28518',
                          '77777','42923','73852','37448','66125',
                          '87490','16276','33906','35174','41317',
                          '14899','29293','32131','99140','37512',
                          '90517','41707','71411','67110','48755',
                          '21350','76460','27618','99855','31883',
                          '17998','80077','12959','64554','41110',
                          '14301','65329','25559','17667','97970',
                          '36255','38575','67717','54241','33985',
                          '28457','55479','79921','39949','58993',
                          '90565','70094','86158','83940','76181',
                          '46814','35646','84027','32962','16839',
                          '50940','73156','58779','72401','29791',
                          '27521','86689','43767','39826','92882',
                          '63136','65048','44628','49544','52174',
                          '10479','89584','10645','42707','71764',
                          '26444','56321','59003','39929','15568',
                          '87079','32450','53223','94130','27101',
                          '37580','44777','69526','81507','79953',
                          '33615','97907','56123','32361','80287',
                          '87331','92526','47064','92912','19484',
                          '12270','50179','33854','51770','59353',
                          '15550','13179','52341','44928','46416',
                          '32526','40210','90488','36672','78919',
                          '19483','63558','29363','62250','34573',
                          '36952','21357','10469','71495','84668',
                          '53415','14306','73959','21907','29481',
                          '72475','88731','44083','43779','48737',
                          '67645','50438','99931','97772','80532',
                          '74473','19490','14377','50926','81492',
                          '92195','62307','15385','26335','52555',
                          '81224','28573','52067','76414','92586',
                          '86383','12293','78851','96387','89810',
                          '74801','38448','92744','57117','29365',
                          '93452','76992','77626','33801','40634',
                          '96037','53384','13345','61364','48305',
                          '41939','79586','18321','96408','88968',
                          '83504','32813','29626','80965','78276',
                          '48461','75530','39872','20659','18774',
                          '69599','24928','61201','91744','83970',
                          '47715','19520','84209','20640','67148',
                          '56670','14614','69744','81247','83756',
                          '42055','57174','41918','91383','45278',
                          '28872','99703','41247','50431','28296',
                          '51732','62491','79798','74668','79007',
                          '89108','91856','14908','52753','21904',
                          '43632','57259','74341','53805','62095',
                          '39070','33901','74564','37199','42626',
                          '74784','61459','45109','39589','45276',
                          '98032','24987','72519','14724','22292',
                          '24518','31414','25592','86418','67366',
                          '83049','11697','53732','66352','89925',
                          '81579','83964','18863','92821','98157',
                          '13544','48451','15535','92004')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100