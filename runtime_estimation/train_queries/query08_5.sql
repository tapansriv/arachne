



select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '61722','44880','12056','99825','60602','50490',
                          '48094','39979','99176','15275','96595',
                          '21934','77059','49919','64691','85015',
                          '64363','25740','94643','91717','89416',
                          '73953','58020','64669','43230','59545',
                          '14431','29873','63260','18538','63248',
                          '35195','46671','35514','67954','21477',
                          '97838','65449','55816','29711','46494',
                          '13945','58401','44514','22608','38517',
                          '44824','30718','44907','72335','95346',
                          '46652','85333','83661','44573','64713',
                          '62314','11357','13627','97825','30217',
                          '93081','51249','72534','57191','26727',
                          '56335','31495','53171','77533','85169',
                          '59995','56303','90892','69862','63240',
                          '31835','18186','19081','83481','96508',
                          '90091','68679','98034','70094','74094',
                          '74236','33638','35078','96589','74428',
                          '67789','91665','12446','40328','75058',
                          '27045','48168','81104','72184','93608',
                          '60125','34391','69479','82553','37907',
                          '42380','27231','25801','19532','33351',
                          '82836','92458','21406','79975','33853',
                          '54503','49781','31466','81090','18849',
                          '77737','37710','28499','77383','89724',
                          '19884','78150','25026','57097','26312',
                          '66194','56934','19921','37024','24930',
                          '73597','40191','61442','92427','14972',
                          '91986','21926','96310','71967','52984',
                          '48666','90541','40079','48643','48973',
                          '41918','79790','90088','75304','78092',
                          '75909','53488','46002','37930','43893',
                          '15336','49404','64340','43378','98835',
                          '25737','69727','22544','94473','26188',
                          '48014','36673','92888','98990','60970',
                          '46048','54700','44535','38865','72255',
                          '15729','53234','66103','52766','34431',
                          '67537','58186','22052','37636','96532',
                          '87751','55091','71190','36394','38847',
                          '70810','67083','68139','43658','36303',
                          '19330','67292','82843','11646','73609',
                          '20521','64961','25820','80445','14681',
                          '48045','29670','12253','82135','87106',
                          '80729','51215','15632','26234','23040',
                          '24895','30994','49899','58570','18831',
                          '13537','84981','43907','18324','51827',
                          '70579','52475','43909','40188','83438',
                          '75177','42275','42565','19475','10557',
                          '72565','86853','62581','81917','15341',
                          '45766','75166','17127','48600','35730',
                          '80377','88883','39200','82542','35449',
                          '27223','82451','40855','53797','55198',
                          '94589','60744','62763','89488','55792',
                          '24626','98728','20648','57921','42925',
                          '91200','13618','53868','83120','60283',
                          '37232','46609','88762','41737','16397',
                          '52993','81395','20320','57542','63798',
                          '46279','59709','66203','94345','17666',
                          '22815','86151','87688','81692','52719',
                          '60931','10988','53817','83586','97496',
                          '35680','73838','74814','97221','64220',
                          '14753','36095','44991','73190','55412',
                          '64295','98466','64019','42177','31915',
                          '14263','90176','18375','99404','62063',
                          '36554','62345','54525','48853','59236',
                          '58507','33436','54115','23750','48093',
                          '50026','23800','75606','60696','90791',
                          '11164','96242','41621','86247','89263',
                          '57115','77504','73754','71237','39480',
                          '68363','34444','67100','54130','10889',
                          '51842','23020','95315','21790','21526',
                          '74857','25563','63935','81149','31127',
                          '58977','51326','17447','75489','62443',
                          '82025','61979','92936','17955','66346',
                          '85292','84474','68572','68499','30156',
                          '60664','68838','77754','45503','36616',
                          '71119','20730','30185','85667','86686',
                          '79200','85869','52372','80510','50692',
                          '91297','83930','36768','24118','39226',
                          '56087','80667','62519','96515')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2002
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100