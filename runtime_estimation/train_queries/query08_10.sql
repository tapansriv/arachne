



select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '52459','32354','47427','89525','34927','89094',
                          '50207','40175','65035','34211','59852',
                          '12509','89411','80845','19745','57023',
                          '91964','12795','38766','34375','63590',
                          '55655','79930','44566','70056','49528',
                          '36707','38572','20947','69238','91510',
                          '51955','79998','61760','24398','51142',
                          '57726','82755','50292','75542','92728',
                          '67802','93718','44821','23323','65874',
                          '69667','34070','38351','64307','90955',
                          '73084','21740','27483','89941','62502',
                          '37328','15475','68559','90736','52900',
                          '81530','23028','52742','48783','82672',
                          '33735','33206','41299','57323','63520',
                          '87076','47024','21906','64634','35377',
                          '57517','86942','47376','63802','74228',
                          '58495','68390','73323','19489','84430',
                          '36313','13452','13281','70294','74909',
                          '65354','88482','17639','68956','29695',
                          '64623','86206','79162','38927','82528',
                          '86084','80502','64544','40659','43717',
                          '98966','71918','68687','81991','22274',
                          '86740','90612','85547','12436','43437',
                          '48006','13834','33523','89571','92243',
                          '68293','30115','89651','30838','67116',
                          '59492','64808','18948','98019','47927',
                          '20810','83346','16772','32787','63631',
                          '87780','24056','29907','55340','84909',
                          '54957','91056','81977','60883','49918',
                          '87913','40686','11375','92158','88251',
                          '12251','34045','31069','63705','42220',
                          '19888','99686','73018','22462','15776',
                          '26022','12612','69915','75062','94216',
                          '47649','99405','22615','78226','61373',
                          '52610','93385','28105','90763','56241',
                          '40695','92189','43520','35887','21838',
                          '60615','88770','74267','71834','75966',
                          '22771','81876','71337','69257','46865',
                          '10103','47317','16414','25945','18001',
                          '77402','58361','92852','73469','63954',
                          '44328','21583','65219','18519','35273',
                          '41717','16131','78422','55185','61499',
                          '36155','12693','35766','44811','83317',
                          '89772','11742','90873','64139','45348',
                          '42407','31418','71499','57396','36728',
                          '52183','10123','56613','97729','88322',
                          '74217','22751','12936','61282','48843',
                          '98986','97743','90312','43148','95822',
                          '70156','95807','38864','96705','96227',
                          '34399','29837','76070','74577','40709',
                          '36710','15602','11255','21389','81127',
                          '25798','99855','72982','15762','96539',
                          '52524','41878','45417','28440','30829',
                          '41835','70451','86915','95086','85041',
                          '89523','64031','79887','58748','38058',
                          '37855','66036','66027','28980','41992',
                          '84066','97685','88571','82140','65670',
                          '33298','31333','58948','93695','17263',
                          '42445','66136','11710','19176','65097',
                          '89336','59307','64814','88716','37000',
                          '20537','19911','32197','96732','74171',
                          '30201','34894','47814','73965','16688',
                          '32451','56231','31736','56143','96471',
                          '34050','50453','69250','16645','70581',
                          '78353','79551','66918','68656','52054',
                          '70587','18748','76142','21234','59594',
                          '26387','46728','77061','60020','94356',
                          '24554','51535','71271','97030','46877',
                          '77068','65746','97403','53221','93175',
                          '79371','22449','65941','49687','29242',
                          '57903','80803','13310','28260','50346',
                          '63623','61680','27981','64615','41217',
                          '55220','99872','73042','52750','76855',
                          '56489','52731','33743','46933','51410',
                          '16565','70551','10811','44260','84200',
                          '26125','33794','68694','16876','32564',
                          '64625','61233','74800','71913','64055',
                          '43607','46001','18578','54224','35071',
                          '44535','35434','90459','11025','48680',
                          '25551','86385','56458','72880')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100