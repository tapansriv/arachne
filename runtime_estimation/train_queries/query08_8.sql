



select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '68494','57917','92114','74844','98760','70598',
                          '65890','66134','78302','44756','80244',
                          '46551','16533','33498','33257','40482',
                          '56591','88056','44633','89463','82689',
                          '18176','43381','68224','16974','91320',
                          '33211','56869','55654','79725','56885',
                          '99764','75249','11237','17473','18414',
                          '76143','80243','31646','24733','68530',
                          '93041','99082','27972','33094','59130',
                          '10419','29065','16785','75953','44510',
                          '22933','22644','39353','43119','54054',
                          '59924','72531','32631','53686','63199',
                          '59029','20080','84693','46521','32052',
                          '63419','98207','23665','99726','94353',
                          '32577','70499','10424','54020','24303',
                          '78498','29469','16617','51373','91552',
                          '99821','66010','99682','87051','27741',
                          '43403','76115','61622','29709','48906',
                          '12058','89657','21187','77192','80949',
                          '37740','89891','44521','42144','34309',
                          '32818','45631','92017','26125','34982',
                          '59637','84842','77870','80010','55633',
                          '20121','77521','82369','85750','16102',
                          '83714','50182','36830','52131','23460',
                          '70328','86618','56393','99380','22673',
                          '90161','49285','26407','20053','10748',
                          '15421','27674','68978','41481','47422',
                          '34532','49385','14493','44053','42332',
                          '80652','52850','39798','34598','23165',
                          '36399','37672','17108','41406','83769',
                          '80639','99256','69696','90047','10131',
                          '37074','34395','37028','83855','58696',
                          '99141','20542','23353','98368','96651',
                          '34920','80764','43093','70579','63644',
                          '31177','74773','26758','19338','25788',
                          '36361','35303','56229','73124','37375',
                          '20077','60691','33043','62565','55103',
                          '77539','75146','48548','85002','38277',
                          '45851','91262','97757','73607','96284',
                          '38093','74281','52664','97859','87357',
                          '96638','96247','79305','64953','56263',
                          '87364','62104','19418','11168','27537',
                          '45450','88516','61674','93349','23485',
                          '12498','38077','64587','24992','44232',
                          '85191','19231','34060','12272','61832',
                          '77838','42018','38852','77775','74775',
                          '43693','75635','41170','19129','35700',
                          '77225','36148','32000','37534','61276',
                          '84065','34269','63268','31361','46259',
                          '44000','16694','79117','79499','56596',
                          '16571','33261','85918','66511','24607',
                          '35259','66082','45961','14924','85734',
                          '39472','10988','87565','92530','28718',
                          '98867','75267','61346','46661','26515',
                          '16065','27661','19376','36262','76398',
                          '36602','96114','34861','95823','81557',
                          '97929','42363','99112','59747','98980',
                          '91025','46816','75557','79625','39366',
                          '82700','92027','41768','65273','20191',
                          '17813','77874','41521','71915','37868',
                          '60913','23340','77472','81958','81123',
                          '55384','92926','93336','23564','72511',
                          '26289','59153','59122','47460','65450',
                          '63373','51820','89264','44258','41666',
                          '43224','46152','53324','35847','86953',
                          '76639','44558','82725','34327','42687',
                          '83422','35696','51693','45501','12316',
                          '94903','54339','47950','71416','91477',
                          '74712','38122','44474','54615','57468',
                          '72620','47292','94650','82481','70000',
                          '46781','72458','82797','99194','39159',
                          '14805','75716','88094','97811','42837',
                          '77238','65396','75350','68299','35169',
                          '13015','43038','27894','17903','85314',
                          '10631','47220','40085','27819','37924',
                          '33004','30260','72522','74195','35914',
                          '39717','82567','26489','51825','30553',
                          '93057','23874','51402','69667','42048',
                          '82834','86732','61010','58277','55601',
                          '38979','90450','17213','96838')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100