



select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '78473','49137','83634','64240','49775','13408',
                          '73622','25131','14206','11870','74909',
                          '66418','68442','17016','12540','77924',
                          '45002','41560','61138','91722','58509',
                          '58257','67369','71804','60268','55505',
                          '94029','86033','80208','16526','73991',
                          '11876','50275','62909','89922','25575',
                          '95471','97437','57080','72997','36339',
                          '95300','24385','25949','92228','56340',
                          '55171','19335','25805','66659','23220',
                          '73749','12111','93048','60894','96355',
                          '95966','17360','52136','67373','70281',
                          '29796','13399','11398','70855','38711',
                          '43085','48104','26812','63181','33087',
                          '91213','27342','10665','36539','90441',
                          '45738','48217','87080','58531','56083',
                          '10541','59196','20693','38537','39675',
                          '80269','20281','35805','87837','65228',
                          '14881','92450','85323','54200','68667',
                          '69971','96839','10768','47707','55940',
                          '46412','89430','80364','34467','11475',
                          '56709','11007','85450','93160','28356',
                          '45163','96586','19477','39785','61363',
                          '36786','61886','94081','76925','18697',
                          '81213','30386','44483','20349','25035',
                          '98737','63620','32285','49364','58157',
                          '20116','77724','34487','67600','38986',
                          '10621','60234','72462','46047','42946',
                          '14233','24182','13654','38629','96708',
                          '21303','80879','33993','96597','90515',
                          '38685','42058','51964','89253','29323',
                          '34337','70616','91390','47471','72293',
                          '14296','67625','92165','69914','68777',
                          '58023','45694','52303','78387','49686',
                          '95380','47187','52776','62748','89468',
                          '21610','41381','83672','11704','41477',
                          '30730','55106','60698','27721','66078',
                          '84536','26116','39390','77086','66996',
                          '73723','84359','36035','52494','94769',
                          '58937','39104','65611','68261','58293',
                          '73223','40353','73006','38807','27845',
                          '52589','85022','52528','94736','15200',
                          '55919','65177','25019','78498','54976',
                          '50707','46839','49408','46829','33874',
                          '24433','50933','50230','25721','25337',
                          '47538','88543','54055','62993','22224',
                          '18677','85721','92652','52883','26059',
                          '74841','22840','82273','42053','34548',
                          '17938','77040','30613','17061','88160',
                          '55839','34050','52263','12024','27753',
                          '38678','13725','48120','55293','13364',
                          '65787','90190','73549','28508','22629',
                          '51664','12556','41805','17335','52548',
                          '26418','16888','87082','27413','46656',
                          '51110','42345','98498','57530','51527',
                          '87564','52964','59534','27058','83269',
                          '90041','75368','90864','72713','62318',
                          '62985','36592','27879','31186','23386',
                          '77054','30047','43324','23233','15039',
                          '92525','74887','77447','23062','52855',
                          '59033','78205','53031','11150','93262',
                          '64778','81595','74369','21418','84017',
                          '90992','59753','30997','93265','67102',
                          '87085','79952','79518','54561','56184',
                          '76914','61259','64872','81649','74119',
                          '63902','20692','52509','45978','17315',
                          '19029','30317','51329','64756','25724',
                          '90791','45937','29822','61854','63584',
                          '99688','40231','82046','33977','17550',
                          '55480','35215','26819','45081','47487',
                          '89263','65028','25427','54811','79237',
                          '80983','30375','23456','37364','33347',
                          '14703','48631','23930','14694','46077',
                          '30784','45665','93426','47192','45248',
                          '79461','89088','78697','30719','56897',
                          '24676','65309','73444','33252','12560',
                          '38607','19150','26925','83455','51064',
                          '89761','75690','23672','57925','21660',
                          '31652','26386','77698','83049','46004',
                          '95416','69057','92698','28398')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100