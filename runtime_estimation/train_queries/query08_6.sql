



select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '26089','77505','16682','68339','17321','14574',
                          '87446','51309','20398','32102','39412',
                          '71932','49341','89712','11328','10281',
                          '30962','41950','86338','32545','36097',
                          '44160','38485','39850','50793','79706',
                          '12111','51224','14229','82501','93367',
                          '56741','46558','80398','86765','27362',
                          '28770','47225','18449','16982','52946',
                          '47687','39731','38548','21213','46937',
                          '27719','28879','86684','29952','84154',
                          '52962','47202','55237','58365','32497',
                          '46423','41777','34443','35670','20903',
                          '86801','73027','29458','51393','99746',
                          '15990','90430','12198','65282','82214',
                          '93182','35466','35303','97144','81225',
                          '95059','18585','43047','58046','56318',
                          '70588','37047','70565','15633','44831',
                          '44318','98468','88995','81466','49147',
                          '69494','39852','80303','58606','32736',
                          '49133','79328','16453','85829','73584',
                          '56451','17508','32473','92844','67979',
                          '88391','70783','16713','29857','10915',
                          '13383','33526','95672','10582','71968',
                          '89720','79796','81072','89426','71547',
                          '59820','36517','52872','71046','19976',
                          '64617','10901','93133','38392','85606',
                          '15608','45886','92343','81011','40873',
                          '15118','73434','33142','37022','42306',
                          '95115','77279','11302','48853','39873',
                          '80289','81327','13233','58470','58287',
                          '75960','77065','76561','77921','77215',
                          '39336','46437','48467','38072','84690',
                          '17537','10554','94163','35700','82750',
                          '20097','43644','23369','91051','77946',
                          '91191','91499','52647','26897','51772',
                          '89330','53829','81071','11665','11300',
                          '73099','30036','37426','59064','73798',
                          '23883','65404','29282','24410','17490',
                          '52341','79921','60106','16379','80646',
                          '15309','52033','21872','90468','71372',
                          '69528','99855','92280','61794','76403',
                          '19034','15640','81532','63588','48417',
                          '85880','75437','71333','94811','72092',
                          '77435','90974','31952','47386','96287',
                          '66061','19180','44137','14057','89986',
                          '42006','25252','37488','70087','12666',
                          '77328','23955','81513','95431','21496',
                          '89625','66114','61620','32139','36629',
                          '62681','51813','92183','16668','65892',
                          '39016','85729','43509','66294','46807',
                          '47087','86690','66583','65879','45217',
                          '69381','66066','79188','96173','64697',
                          '82334','68690','55429','52808','51549',
                          '83293','73404','63794','21040','91368',
                          '74520','78921','58357','82358','66635',
                          '10726','83323','23139','31852','56723',
                          '67353','44594','73675','79955','21732',
                          '45432','50068','92878','73146','81751',
                          '91862','73973','72133','64559','57774',
                          '87300','15566','57501','40195','31332',
                          '81984','94573','56220','45153','49790',
                          '71571','99109','86840','28124','60121',
                          '34649','64888','27655','50052','82148',
                          '66568','25550','68733','57904','79407',
                          '74460','46163','51137','64488','80061',
                          '75228','62695','59631','57185','44493',
                          '44657','17396','79073','59614','12665',
                          '28571','48338','86944','86321','22353',
                          '45527','82252','74787','89919','90700',
                          '93453','83261','55560','54909','33261',
                          '15111','89335','24499','29243','70548',
                          '32027','40418','41168','49513','63233',
                          '20325','72081','66553','30719','54395',
                          '40045','96500','46955','64233','12402',
                          '52573','35390','67922','54470','66356',
                          '45319','23449','33694','75120','74608',
                          '62246','25032','69730','59652','96666',
                          '14374','84868','37586','72973','48698',
                          '31189','68424','36763','65246','75161',
                          '70672','90170','99616','22952')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1999
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100