



select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '69058','69840','95839','87006','65629','48872',
                          '99185','28124','85096','21074','77751',
                          '24883','71443','24701','35920','61549',
                          '55041','27473','24690','24844','85528',
                          '74548','99558','62135','20143','15633',
                          '86646','18576','69585','39987','57706',
                          '15100','81349','54965','20266','90715',
                          '10763','94603','74143','86013','26914',
                          '64183','59920','41719','76295','63110',
                          '83981','17709','13442','43637','25732',
                          '59644','78419','69872','79426','15025',
                          '72436','70453','23024','59467','27609',
                          '55139','73213','15766','97915','65034',
                          '91145','17259','32354','15291','36723',
                          '29084','37696','22497','11988','66485',
                          '45471','94710','84388','19153','94299',
                          '92846','86083','36822','63297','48737',
                          '13526','59332','14463','78921','72745',
                          '52303','54924','60340','36293','34310',
                          '72455','71161','71863','52205','23891',
                          '55851','70176','47013','51404','88667',
                          '88504','96410','32017','77517','41187',
                          '13011','76847','97335','77363','96078',
                          '13512','50603','76318','87488','53270',
                          '58890','88272','63962','50538','26002',
                          '95985','91910','94080','82870','67760',
                          '66651','57337','30976','89676','81541',
                          '47661','14636','84037','16011','76201',
                          '29226','62534','94358','12608','34084',
                          '34586','49957','37797','18292','68888',
                          '83060','49236','33872','67766','19192',
                          '56179','82733','25521','59424','17519',
                          '88605','78960','44149','19763','74786',
                          '46297','41900','54096','39974','40205',
                          '11835','41161','36644','60883','80508',
                          '40270','20555','90839','70173','88961',
                          '80408','34673','17649','20685','23706',
                          '55421','83986','76690','87991','72780',
                          '35062','85902','59416','24305','91750',
                          '62815','38017','72674','37354','99951',
                          '70813','96062','72433','90749','55109',
                          '81390','97765','96409','89315','67011',
                          '99225','54695','91824','99362','31990',
                          '81948','29750','43651','87020','37777',
                          '43503','48517','53623','46326','34217',
                          '22227','38526','58681','64476','32920',
                          '66233','42740','32561','29374','28585',
                          '10324','46768','46108','19897','83999',
                          '40552','36447','77424','29248','59438',
                          '71291','49527','31162','76862','37185',
                          '87346','79738','20204','54679','26087',
                          '35115','40334','40476','33707','93024',
                          '97888','19655','50060','26305','38411',
                          '41395','94756','25955','23655','44228',
                          '54011','13148','82021','37988','41278',
                          '47160','75828','37758','99210','85772',
                          '27697','15745','85998','56032','38153',
                          '38802','52434','12804','70793','61111',
                          '83193','62732','10444','42801','77535',
                          '23406','30592','19116','74333','18253',
                          '61615','74998','57941','73263','51992',
                          '62316','38595','96393','95994','60065',
                          '35476','92603','18948','49727','11407',
                          '68595','54724','69028','12003','18527',
                          '14734','14343','93424','61781','84814',
                          '73694','78153','63229','47087','45380',
                          '86899','15859','79758','48897','58668',
                          '54875','33472','47111','61586','43731',
                          '65984','28194','80620','44771','75791',
                          '51617','15911','95629','29989','44407',
                          '93591','43355','11195','66807','32536',
                          '17654','99499','87510','51042','70832',
                          '75927','56321','88795','26763','22455',
                          '99294','95150','68175','69182','33923',
                          '14084','35102','54013','67110','22597',
                          '12015','78017','82366','88726','11433',
                          '86895','78931','50076','54817','33553',
                          '45188','81119','91074','16401','19229',
                          '95863','50631','41940','78239','89261',
                          '51074','25911','10419','92738')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2001
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100