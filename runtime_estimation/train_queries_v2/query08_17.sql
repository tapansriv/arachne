



select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substring(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substring(ca_zip,1,5) IN (
                          '51955','91241','29861','88704','90197','46152',
                          '93168','58799','76645','51471','60498',
                          '34769','59957','71224','31691','87958',
                          '44199','49290','16924','58469','56953',
                          '18165','57106','97335','91360','83797',
                          '90343','23856','48089','48073','64674',
                          '57961','34188','16545','29902','80776',
                          '18291','83809','88850','46157','13070',
                          '42958','41454','75361','59783','29952',
                          '93358','16633','31896','89057','79553',
                          '22381','75092','57915','24989','85771',
                          '34833','72159','79927','72740','61333',
                          '20560','79684','52475','46921','16648',
                          '17033','69919','10719','44866','95207',
                          '21919','64657','91239','70528','14140',
                          '39453','89332','87936','68507','96221',
                          '98215','56301','65511','95405','43652',
                          '25796','68232','18299','41686','36649',
                          '26389','42509','26158','53168','97410',
                          '86816','49710','36137','57673','26756',
                          '29759','30588','97868','47281','10264',
                          '64312','98386','37203','57944','50977',
                          '47283','24605','56552','51523','65391',
                          '10249','83557','77383','72506','88777',
                          '32164','77695','38677','64455','11322',
                          '23524','68840','64416','94300','20870',
                          '82404','61506','63727','51215','29613',
                          '88371','56558','66633','64970','78221',
                          '42953','20533','90762','48358','42163',
                          '23924','45666','81273','29906','61838',
                          '80126','88021','98211','59280','40237',
                          '47312','91170','75204','27756','38507',
                          '13013','59223','28205','31909','91481',
                          '37421','79593','45429','99946','24337',
                          '19606','42393','65376','28827','92048',
                          '18086','32470','18344','34155','99066',
                          '97214','43513','99161','85134','22956',
                          '84372','87488','54369','27684','53157',
                          '61818','66449','89341','43005','40241',
                          '64625','17967','94499','64505','77825',
                          '21270','60941','51205','76191','32319',
                          '62471','11173','50129','78422','75294',
                          '61753','46107','58352','20036','86019',
                          '44716','15796','64861','27530','28289',
                          '67129','30431','19170','95734','19366',
                          '95728','38639','65646','47743','83808',
                          '91648','30407','66115','19328','28141',
                          '90075','90607','91613','48629','32293',
                          '45589','69185','87261','32362','41280',
                          '67587','12636','36565','98734','71993',
                          '35020','74618','98247','24663','48958',
                          '54170','71684','82027','81314','89587',
                          '28773','14145','78778','57665','24869',
                          '21860','72457','70337','15354','44184',
                          '55399','33055','11261','43139','92608',
                          '37417','14260','16332','33125','12059',
                          '43105','23120','22491','98675','66514',
                          '57347','57768','37451','59482','36848',
                          '55784','53221','64653','37126','88862',
                          '18864','74404','84247','87169','19501',
                          '35211','97271','37736','89728','38501',
                          '93877','50168','40095','96611','58116',
                          '72660','63556','68481','48213','94731',
                          '43219','80566','71605','82679','51028',
                          '39745','25695','87676','32435','52124',
                          '32452','90610','32084','19743','68497',
                          '25662','32517','65279','57298','89128',
                          '89247','36792','69127','24102','27327',
                          '67952','98141','50899','95631','67442',
                          '69471','38270','94674','29812','49289',
                          '20944','51061','73337','95171','85943',
                          '41616','41106','70386','17456','15532',
                          '52665','53841','35818','21245','25920',
                          '55452','58524','17230','48941','79172',
                          '10443','81249','62074','87510','97286',
                          '60538','18118','19593','86052','65323',
                          '29076','76671','86839','60886','34881',
                          '85136','68387','42418','84839','71936',
                          '70584','58663','55370','88025','45075',
                          '50482','76839','34707','58040')
     intersect
      select ca_zip
      from (SELECT substring(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2000
  and (substring(s_zip,1,2) = substring(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100