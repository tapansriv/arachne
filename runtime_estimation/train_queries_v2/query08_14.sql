



select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substring(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substring(ca_zip,1,5) IN (
                          '73506','70935','67839','41806','76908','50798',
                          '46022','15903','28152','22876','79716',
                          '35120','39022','38410','33599','40104',
                          '61094','17044','29882','53761','22768',
                          '33880','58881','21811','74097','10997',
                          '48326','87534','92619','12625','85675',
                          '69472','45293','86856','43960','36345',
                          '58833','58689','48944','44435','37960',
                          '50061','63644','97839','62296','71762',
                          '93536','18153','28819','81092','31180',
                          '38010','57994','38631','37688','72136',
                          '75488','93911','53352','85970','91072',
                          '73822','21304','71689','43613','10369',
                          '32984','51708','45848','68619','71918',
                          '20145','25304','64983','21411','78181',
                          '15908','40583','23218','33551','67656',
                          '47371','92877','12656','25144','63604',
                          '54643','95190','47218','71266','21933',
                          '77977','63308','99648','98819','82139',
                          '56792','56648','56640','35869','93041',
                          '62902','73789','83903','90427','60798',
                          '84348','92453','96955','22197','16438',
                          '74167','48222','18531','80401','87830',
                          '31123','23070','31913','87744','35362',
                          '42185','46020','89060','29871','75526',
                          '48207','44972','57920','17445','78200',
                          '64142','11980','29694','62766','36202',
                          '38892','40500','44253','28122','98739',
                          '29806','57874','42052','90575','70228',
                          '12826','30890','12231','70108','89866',
                          '78760','19153','67489','27720','42789',
                          '75326','92013','99257','27122','16508',
                          '16514','58270','33376','60978','15402',
                          '72244','73855','89998','46466','33166',
                          '96526','75499','36238','48392','82832',
                          '97348','44306','84629','97562','72089',
                          '94005','67182','21124','67805','52905',
                          '38683','23555','89910','21972','11599',
                          '28269','88200','62981','47816','56665',
                          '60107','79344','79098','23965','52139',
                          '59656','19938','81196','53407','77002',
                          '38235','75734','28575','80396','93009',
                          '21722','29431','76210','14486','19672',
                          '14469','30130','13085','91490','87116',
                          '27691','42239','92990','67856','48546',
                          '30411','91412','74312','77097','56222',
                          '37795','97166','83595','68870','86684',
                          '96580','20382','85778','11784','72948',
                          '18141','67506','66779','87427','54277',
                          '67310','31370','44928','58217','12784',
                          '33611','69253','36107','24333','55156',
                          '16937','99695','64169','83762','70917',
                          '38213','63169','10803','57119','26794',
                          '48269','20336','46400','37243','10823',
                          '88480','46952','30354','72379','64019',
                          '68979','13845','90154','59866','89978',
                          '95769','30509','99354','54412','64326',
                          '93749','98324','84845','99606','54592',
                          '95245','99686','24312','94594','66268',
                          '26009','94372','27957','29776','11683',
                          '28602','58307','33616','55250','30393',
                          '19134','36716','99414','15448','86366',
                          '28965','35433','38649','21077','40827',
                          '34737','82816','25169','64724','39477',
                          '82743','13892','40840','97865','37414',
                          '97003','44243','36094','22808','81591',
                          '90313','53294','49611','96106','31416',
                          '71431','67094','74846','97353','99737',
                          '57511','59789','59271','51602','69987',
                          '30348','82620','78497','28086','32550',
                          '84682','78788','51700','89064','26732',
                          '63321','32490','91877','43840','47522',
                          '16531','18068','95678','14913','46390',
                          '39355','73852','40221','53598','97056',
                          '78052','22353','83896','79159','29104',
                          '45715','23185','58435','74446','99872',
                          '23580','83849','85224','10829','37786',
                          '35395','40900','28263','65710','43204',
                          '33727','36140','72275','32628','81697',
                          '63518','63676','19011','17525')
     intersect
      select ca_zip
      from (SELECT substring(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2000
  and (substring(s_zip,1,2) = substring(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100