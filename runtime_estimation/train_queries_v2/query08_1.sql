



select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substring(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substring(ca_zip,1,5) IN (
                          '17494','60432','13146','43237','98575','51261',
                          '81764','19905','69410','12894','38884',
                          '10503','24136','36674','40945','31466',
                          '55658','23960','62765','22163','59780',
                          '29836','86632','73075','36328','72449',
                          '29877','41001','22879','23470','61525',
                          '19571','53289','99646','98125','54659',
                          '84649','79482','20421','54656','57549',
                          '64452','41298','24645','14653','41837',
                          '51438','67578','58505','55239','39908',
                          '75985','83938','36646','43067','61111',
                          '15987','50031','20765','40665','15891',
                          '31148','60171','12832','46914','18313',
                          '76093','13597','71978','85081','42566',
                          '18628','97242','75809','27919','33799',
                          '81761','39395','90627','41534','41094',
                          '15758','56666','95264','11875','10782',
                          '23143','67624','41968','12217','32048',
                          '57349','74722','82149','48934','85236',
                          '83935','45433','55913','61123','63692',
                          '64020','73178','93546','41000','80728',
                          '10734','80558','11371','13938','39000',
                          '67128','26741','15783','11403','74744',
                          '19276','69624','62748','39863','89020',
                          '45531','67988','96505','15388','64048',
                          '19912','20302','97113','63800','36016',
                          '32737','63558','36975','37360','72685',
                          '89216','72664','12501','34415','75402',
                          '14655','11696','20259','12112','93654',
                          '15248','62762','60731','44846','70130',
                          '69230','59583','22907','74352','53276',
                          '63523','64919','12359','82007','49183',
                          '43234','31386','46224','21984','80961',
                          '48439','80029','11412','36941','35777',
                          '15657','39575','14819','82851','38376',
                          '85495','86906','24710','31870','67058',
                          '60160','16671','26124','87626','72071',
                          '43452','55852','72174','62068','12471',
                          '49710','68578','65944','64838','49105',
                          '75040','58851','38071','18421','57214',
                          '69255','89839','14381','14927','19272',
                          '17766','13264','71984','24737','93517',
                          '88707','82545','83886','96570','32010',
                          '47467','34578','84228','21026','13595',
                          '48426','41017','75798','97143','70242',
                          '57875','14739','30694','58564','39516',
                          '43068','56020','26486','99331','22549',
                          '41056','45802','69446','62118','24802',
                          '36895','95346','33682','32506','18108',
                          '64751','14327','44125','83507','19176',
                          '19347','92376','81534','10428','30656',
                          '16239','31752','46413','59349','55584',
                          '82204','65415','92879','37622','20478',
                          '45919','28164','22272','80262','83893',
                          '79616','93781','36828','12662','85046',
                          '11573','29585','95445','66084','97773',
                          '37772','82789','78202','92915','73990',
                          '32054','41800','53555','25120','51709',
                          '31951','21502','58293','45477','29664',
                          '57931','31950','88326','47215','56594',
                          '50366','93643','76302','94588','66010',
                          '34731','74103','78350','88433','45263',
                          '55827','12872','67554','28900','58185',
                          '48848','62816','25807','68122','70493',
                          '99976','89467','83806','95807','54678',
                          '57767','17458','21714','88450','88682',
                          '49480','59107','17677','40523','21946',
                          '14511','32142','10484','15175','62207',
                          '21687','63454','31856','12803','10536',
                          '46778','20692','67258','18059','32747',
                          '38378','22701','45130','43936','31574',
                          '17188','48825','23013','36268','48789',
                          '22909','22667','21649','40701','63124',
                          '16733','23745','67788','68832','31409',
                          '37337','33718','33807','14495','47633',
                          '43654','16215','54669','44171','59252',
                          '15815','15661','17046','24977','43817',
                          '12618','86162','62238','20172','35462',
                          '43993','22631','73522','18209','17779',
                          '73395','48589','64027','50797')
     intersect
      select ca_zip
      from (SELECT substring(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1998
  and (substring(s_zip,1,2) = substring(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100