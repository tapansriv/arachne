



select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substring(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substring(ca_zip,1,5) IN (
                          '69840','79031','42951','30294','16748','51017',
                          '16821','43549','21065','24417','51150',
                          '66861','43395','25040','10791','56686',
                          '81361','30214','77540','37596','17175',
                          '38027','32407','73183','66572','71992',
                          '30975','46701','30688','20754','89048',
                          '83010','82387','28817','54887','45265',
                          '75113','18699','95627','23795','91337',
                          '79930','21888','89853','83346','49564',
                          '51892','32378','63292','13650','77371',
                          '53068','20320','88672','40804','15898',
                          '40138','17546','24604','25957','66411',
                          '96041','38164','78874','70636','14239',
                          '43892','28610','42547','83133','98483',
                          '48607','37816','55991','95625','99984',
                          '17953','76409','95495','77176','65727',
                          '19158','37623','62009','70804','86877',
                          '86488','34863','87300','13730','93133',
                          '65526','62616','61467','86863','60726',
                          '52798','36323','40541','71189','57968',
                          '74346','39083','26271','95774','58857',
                          '83354','49732','19265','21904','14791',
                          '97984','12598','18095','65331','14883',
                          '37730','69081','16927','12561','30095',
                          '44092','99512','40444','75452','46098',
                          '19029','40150','22843','45755','98562',
                          '78129','44724','10604','11804','68455',
                          '33237','56971','86831','29141','47509',
                          '95113','91969','83349','97690','84620',
                          '47731','62065','88818','69718','55545',
                          '77923','92023','15668','30006','51637',
                          '18761','97858','10989','63578','67275',
                          '44679','29205','55795','31437','75252',
                          '35393','76020','61492','47498','36804',
                          '31673','99220','94342','89397','18327',
                          '87519','25676','90139','56943','97125',
                          '93465','18378','87600','69714','44797',
                          '54732','32702','24922','86997','73760',
                          '19042','85853','47895','49777','90153',
                          '27398','47320','48610','83248','25898',
                          '21427','33631','74588','27294','60630',
                          '65263','63090','32401','84789','40169',
                          '73500','47154','12241','13975','68029',
                          '91408','83223','57089','92828','58149',
                          '94791','25473','58724','36551','82627',
                          '59312','94289','16390','23435','38498',
                          '69751','71644','77757','23086','14446',
                          '73248','62969','82504','51988','15623',
                          '83569','78249','16002','24304','94331',
                          '18348','45125','90364','83647','29342',
                          '57886','80347','81060','89481','75656',
                          '40200','37543','55286','28250','82745',
                          '33762','27764','94349','69739','85416',
                          '53981','46004','82942','46382','34896',
                          '97591','79430','91036','77584','88074',
                          '45016','41990','82964','15735','99869',
                          '92463','90391','12867','36751','77399',
                          '89635','65451','26798','80975','99684',
                          '71190','83682','42011','52262','88142',
                          '28119','84910','71033','67728','63108',
                          '86543','86276','51595','52547','25549',
                          '26001','37718','80736','76524','27720',
                          '81457','43114','74953','65188','99159',
                          '39350','55967','14127','34673','71754',
                          '78841','27722','40779','76458','23862',
                          '70555','54378','96589','96552','59138',
                          '77907','65502','11733','76317','62828',
                          '88941','70847','82603','91354','69402',
                          '57148','26928','72914','40075','76664',
                          '51225','18153','53569','20703','58335',
                          '23785','48385','18146','61517','89507',
                          '20596','59140','35899','74017','37688',
                          '72799','67876','67135','80404','16570',
                          '77875','21091','12375','24647','34536',
                          '59830','59744','24873','61078','29978',
                          '67837','37563','78283','49983','30452',
                          '33404','19510','20258','36663','75011',
                          '73975','76268','41701','95840','33115',
                          '44162','61841','81390','35140','26467',
                          '75234','47953','31846','12591')
     intersect
      select ca_zip
      from (SELECT substring(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2000
  and (substring(s_zip,1,2) = substring(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100