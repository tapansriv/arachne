



select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substring(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substring(ca_zip,1,5) IN (
                          '73600','13428','14219','57139','23020','97507',
                          '86385','92821','95844','96324','86843',
                          '77318','28073','18841','65907','92211',
                          '56717','85062','73595','83221','61113',
                          '10631','53291','97207','68639','67786',
                          '18176','91557','79705','75440','73362',
                          '70123','27802','51240','65517','10213',
                          '97231','31462','37896','35950','51411',
                          '14414','35435','33277','25093','47154',
                          '37353','50769','10524','79914','39489',
                          '10183','81189','52518','62342','66446',
                          '39674','38910','41992','77359','95007',
                          '14641','43579','58517','95565','37211',
                          '90531','88313','69338','72982','92174',
                          '96501','16388','49392','80532','26512',
                          '41295','34833','53366','48674','33987',
                          '54661','36145','19502','83871','34601',
                          '34210','50416','96420','56357','61246',
                          '30205','48695','44758','81137','51350',
                          '95775','62626','15488','41651','38176',
                          '68651','51372','37735','37208','49868',
                          '60900','28340','33655','15109','47428',
                          '86247','75408','43811','38344','27002',
                          '39964','49903','53888','39269','91068',
                          '67385','79703','92146','14384','60978',
                          '59779','91444','16368','48098','51593',
                          '89886','66658','83836','73928','93418',
                          '93894','28057','80478','20117','58598',
                          '43897','49043','31799','87744','76909',
                          '90858','81492','24244','22887','87589',
                          '12535','25732','23532','80241','26544',
                          '67545','15829','29416','75846','21926',
                          '18310','71852','42753','32725','41079',
                          '12948','14280','54672','86000','76839',
                          '23643','83619','17266','67386','73519',
                          '63948','57395','69762','64814','90825',
                          '97592','98457','42333','73246','98460',
                          '52978','94645','58694','12828','29397',
                          '42082','94842','37924','57159','96646',
                          '99599','92375','81294','71066','33138',
                          '69332','39809','17371','65035','52103',
                          '57204','31504','82598','86535','98439',
                          '91690','67402','89486','50377','12095',
                          '39812','74341','80401','95676','74048',
                          '39449','97473','54268','35729','10313',
                          '57541','66944','78245','97788','60222',
                          '91175','47596','68506','81120','96511',
                          '59453','75162','81479','89514','77160',
                          '21161','37304','14286','61405','99246',
                          '36189','44439','22054','19076','45297',
                          '34651','22636','69856','44088','10394',
                          '16951','56529','38126','81465','19156',
                          '58839','45424','84829','18702','72809',
                          '53408','75413','74142','76386','65189',
                          '99842','88985','95282','97137','71164',
                          '27516','78252','85639','16008','29754',
                          '21079','87668','19887','31364','35058',
                          '28763','99979','74433','76214','38755',
                          '19048','30996','83090','53200','37028',
                          '26158','59915','12376','87455','26886',
                          '39096','12548','50423','55949','35651',
                          '66614','74708','89211','71439','23502',
                          '85097','57358','52085','45600','84849',
                          '11673','29074','95597','45609','93747',
                          '28488','17172','63913','67972','62777',
                          '11436','88909','94220','57266','41364',
                          '84426','97831','23061','47342','69820',
                          '49834','81645','51150','32789','39519',
                          '54038','70007','33833','23949','94217',
                          '70666','88660','11497','72249','60681',
                          '98737','87041','54589','91041','90984',
                          '43910','73866','53845','99041','75447',
                          '57067','83084','67198','29209','57000',
                          '44549','84589','27814','93636','68152',
                          '91586','21900','15830','46821','85080',
                          '35853','43973','64948','21085','34590',
                          '53624','84160','79744','43513','82060',
                          '13928','24805','54625','12550','49053',
                          '29346','28734','41937','57240','66507',
                          '11482','19110','47691','45377')
     intersect
      select ca_zip
      from (SELECT substring(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1998
  and (substring(s_zip,1,2) = substring(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100