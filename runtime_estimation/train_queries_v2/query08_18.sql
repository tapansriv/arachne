



select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substring(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substring(ca_zip,1,5) IN (
                          '91825','60404','27774','37989','39101','41888',
                          '39996','51358','99800','13031','77439',
                          '57838','54803','92713','47433','20220',
                          '76804','10522','86086','95904','27626',
                          '83023','32451','79974','78613','32148',
                          '64782','78489','81024','34584','72878',
                          '57170','68804','22814','35032','97597',
                          '64062','62656','68299','58469','15244',
                          '14129','49095','12098','87992','18040',
                          '36824','85343','33970','25849','86141',
                          '11117','89426','83239','91485','96174',
                          '75033','99264','77436','95944','46198',
                          '78007','39529','59771','13859','61981',
                          '45807','55732','21322','38200','89393',
                          '51298','57217','24011','74886','54590',
                          '97317','59633','84666','45904','78311',
                          '31214','99594','66033','89838','96692',
                          '97926','68722','39441','11261','29615',
                          '40901','28610','56994','95013','10738',
                          '18776','68325','87104','14045','89885',
                          '26849','84237','75984','61759','30397',
                          '89181','30533','78179','57258','19273',
                          '10286','36845','78100','55915','22634',
                          '25977','81095','73280','64942','47492',
                          '20639','61220','33539','50266','43848',
                          '64358','67518','36647','21932','26888',
                          '78526','65688','73880','95212','55768',
                          '83508','40588','84520','91196','33487',
                          '86820','30821','77548','54104','94619',
                          '69249','82616','34309','33167','61384',
                          '83628','87350','73609','23995','15845',
                          '18598','49217','33998','10037','68890',
                          '49197','66765','35203','40369','27412',
                          '37056','73127','25020','27341','69125',
                          '23844','52761','96737','91573','60423',
                          '33731','45164','94420','23734','92342',
                          '75358','15880','52942','86770','52540',
                          '69784','73465','71609','95124','92301',
                          '31368','34936','90897','44593','78417',
                          '65948','79358','31829','64578','55389',
                          '30747','50738','75042','55430','44488',
                          '82478','87184','53926','61414','75438',
                          '82126','87942','57188','98018','34457',
                          '98045','20342','82003','56747','45092',
                          '44552','64973','81342','54501','93422',
                          '73267','37884','88255','63779','14620',
                          '83889','37554','40393','56159','78625',
                          '21233','73906','61288','57479','89180',
                          '43413','43786','90297','34832','85915',
                          '20562','19478','15249','90566','19928',
                          '98673','25360','64789','76655','56599',
                          '88104','61863','51703','96640','75636',
                          '29023','40181','24600','32027','75147',
                          '54488','93375','35244','83369','83005',
                          '86162','41397','15932','97585','56208',
                          '66895','27553','48596','79965','16822',
                          '48801','85656','10624','83246','99625',
                          '95361','38189','27930','29082','17390',
                          '72678','93268','63821','68740','36378',
                          '32086','84483','42813','20286','31225',
                          '56790','29536','21911','50421','14703',
                          '76961','23349','14182','92947','33805',
                          '22085','26105','88146','59955','35417',
                          '53032','68978','81022','71153','33660',
                          '78777','31140','23369','51596','30354',
                          '50957','72753','43051','42188','48562',
                          '37790','38794','90869','94766','46277',
                          '82674','61404','29225','96140','91842',
                          '33477','26569','71681','88594','42435',
                          '28221','61733','41436','85075','70521',
                          '16850','48731','17609','95158','31766',
                          '12905','87657','11324','55531','17450',
                          '47107','88857','77194','61219','45429',
                          '41761','44404','18378','49540','67398',
                          '35132','68958','58732','60737','87359',
                          '79568','73436','97885','74450','14606',
                          '69701','85692','89368','54824','88836',
                          '48759','18239','88848','99686','15213',
                          '64550','92785','86997','26553','85066',
                          '86611','93951','30886','73277')
     intersect
      select ca_zip
      from (SELECT substring(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1999
  and (substring(s_zip,1,2) = substring(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100