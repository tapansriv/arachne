



select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substring(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substring(ca_zip,1,5) IN (
                          '88323','94682','25746','51048','75913','19520',
                          '89544','35884','50692','20234','83489',
                          '88788','76885','14578','81808','57568',
                          '87615','16335','33474','90692','99504',
                          '59094','36502','60276','40246','25464',
                          '70034','70234','91672','94392','53435',
                          '76262','26859','95348','37512','26690',
                          '78511','24785','33336','97734','53935',
                          '95476','23603','83386','53959','32518',
                          '44806','13537','63973','11620','90419',
                          '84514','15803','23003','87181','82354',
                          '96565','73827','51992','65701','56321',
                          '28603','99433','11906','48082','62952',
                          '68275','30313','21541','94206','14997',
                          '68578','54087','90053','43613','38228',
                          '88083','66739','54264','55353','76789',
                          '61468','93334','29532','27510','98203',
                          '11270','84104','13951','96705','54788',
                          '43962','54815','38930','57588','69572',
                          '69701','60735','59606','19146','71906',
                          '66706','62879','72580','41787','40626',
                          '67533','74615','38784','56924','27519',
                          '40095','13300','53820','72797','95575',
                          '90849','37755','96226','19551','67877',
                          '67599','58921','39639','35588','65021',
                          '95211','36757','87625','91037','70179',
                          '73708','48961','77068','56903','52278',
                          '49157','46001','64873','15418','19792',
                          '42399','69250','47996','31426','73129',
                          '42366','63218','60681','93571','13462',
                          '88581','94961','70186','49682','42894',
                          '69951','38902','71347','94733','25417',
                          '85552','47891','83826','48722','50868',
                          '19498','67707','62983','10574','83856',
                          '50307','78642','56272','54133','16241',
                          '53715','19987','62261','98748','19692',
                          '51852','98330','20644','54075','52309',
                          '75658','57080','41454','98888','53300',
                          '16612','43047','74338','63082','24579',
                          '65577','10653','42944','75125','14909',
                          '52414','10696','33820','47983','95968',
                          '20161','31516','27281','93285','58918',
                          '91618','25716','25149','29932','95177',
                          '49655','95356','96564','66146','83138',
                          '29641','38810','58938','36682','61033',
                          '71018','45347','32722','70335','72197',
                          '71845','71369','62942','35770','79345',
                          '69699','80841','58447','73788','21842',
                          '55883','86668','55502','79724','67976',
                          '50846','84788','10610','12920','69546',
                          '11895','35258','25318','42666','29488',
                          '29258','47833','34124','21624','77230',
                          '51633','55601','59623','23185','27828',
                          '81411','71004','25630','81822','64252',
                          '83751','99559','36824','26009','41601',
                          '93679','61255','58194','14823','10954',
                          '57635','14260','46676','56065','88992',
                          '53896','59225','10225','63934','98423',
                          '26365','35678','49481','53827','45697',
                          '51485','30464','81614','31443','25363',
                          '90441','28109','19145','45310','33696',
                          '43428','99502','26298','20692','38568',
                          '23221','24885','14901','47618','10494',
                          '79317','67032','81295','44928','58755',
                          '62567','45194','57094','41280','80238',
                          '87472','91524','28490','34238','97205',
                          '24313','14638','11812','17126','43236',
                          '21710','25729','26663','66094','27195',
                          '79616','73281','47306','41154','43225',
                          '53204','21594','88859','82990','62503',
                          '62355','19605','55991','59881','79436',
                          '18073','40090','79980','50405','71785',
                          '82914','27074','40294','33215','88963',
                          '70664','73093','22334','18287','76622',
                          '97440','13159','34072','87920','99132',
                          '41181','66654','79557','77416','73861',
                          '48251','48965','78922','45463','22311',
                          '19283','61011','16021','40478','32218',
                          '25701','64848','26699','71437','99735',
                          '24535','79781','59050','80924')
     intersect
      select ca_zip
      from (SELECT substring(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2002
  and (substring(s_zip,1,2) = substring(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100