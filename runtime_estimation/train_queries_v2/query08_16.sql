



select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substring(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substring(ca_zip,1,5) IN (
                          '51841','78486','89024','61503','75898','77684',
                          '86747','67467','63153','72373','98427',
                          '33986','66997','89610','24604','18959',
                          '62708','59349','79720','33487','28738',
                          '53274','26703','19641','79188','54550',
                          '98865','17322','85387','88670','10963',
                          '44779','35156','10474','58642','27303',
                          '90517','51105','72786','62163','39185',
                          '94229','29275','43472','49702','47301',
                          '35425','67895','28931','29552','82633',
                          '90396','64347','80371','41920','43851',
                          '88312','95538','45427','95184','83259',
                          '56567','83571','88299','20398','81739',
                          '22114','25179','81189','48403','94301',
                          '18151','44727','26829','96159','12958',
                          '47418','95942','38666','42862','68134',
                          '48179','41713','61701','13595','86314',
                          '65271','53878','62457','91119','90745',
                          '26037','34498','93382','11250','46943',
                          '67321','78062','44981','89443','59790',
                          '14202','35389','68444','99547','93924',
                          '74593','58536','84962','67623','46965',
                          '76569','74047','64556','11494','74724',
                          '45658','71373','63961','97583','40095',
                          '22313','13403','31655','43522','62168',
                          '81485','36901','16757','21548','47901',
                          '89631','18156','81528','91046','52726',
                          '92531','58308','28393','19559','63310',
                          '36808','26582','73187','25154','30110',
                          '59160','75218','68841','69543','99967',
                          '96958','44290','51986','13037','77655',
                          '76464','84234','99444','82503','57967',
                          '15872','39298','43728','59419','14871',
                          '22280','70579','26126','81249','56606',
                          '31320','37296','76703','28180','91817',
                          '74301','22103','75968','45997','57801',
                          '40966','37868','42333','25656','93098',
                          '12040','94607','48052','21469','89999',
                          '68662','52899','68121','73501','81034',
                          '88157','25218','91564','77774','49691',
                          '67105','76817','54862','84350','62361',
                          '68321','99289','86726','64007','82771',
                          '64775','40924','95109','15224','33585',
                          '76857','20388','95662','93148','26719',
                          '51242','92854','53455','40203','71139',
                          '66895','26467','75122','49459','56036',
                          '40719','50499','26145','29347','39824',
                          '26683','78533','54319','80896','71018',
                          '74949','75732','78626','98324','24729',
                          '23703','44116','87958','65499','31478',
                          '21317','25132','52607','53927','45230',
                          '99372','79326','51740','23061','74467',
                          '26102','53671','72179','43969','76300',
                          '47626','57383','79471','50023','89576',
                          '16174','67451','34546','61760','78566',
                          '24666','38912','13206','61698','81553',
                          '79286','74864','82111','32484','54842',
                          '24973','79750','36723','34656','35594',
                          '50623','70621','15036','89215','52628',
                          '10086','30455','44620','66770','25421',
                          '79104','52383','82717','10900','38637',
                          '74739','94133','62331','50266','96434',
                          '87303','45424','12980','39326','66654',
                          '33828','41265','68671','13521','54268',
                          '11729','67874','41226','38948','97385',
                          '86379','89124','67725','30881','64419',
                          '21567','31717','18011','54490','51786',
                          '91481','45678','28641','22473','88898',
                          '53236','12064','89118','34767','56644',
                          '51063','32243','56330','62463','92560',
                          '95122','41644','21594','67262','88001',
                          '42085','93080','93704','83744','81550',
                          '29216','77143','14439','80537','55205',
                          '63699','91201','13334','24961','74693',
                          '69219','98456','36108','97944','53741',
                          '86054','70522','77757','50116','29262',
                          '60224','99122','12451','71058','45254',
                          '18062','22720','58882','48486','67772',
                          '18224','57359','23822','44789','86914',
                          '35007','20478','11065','11314')
     intersect
      select ca_zip
      from (SELECT substring(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2002
  and (substring(s_zip,1,2) = substring(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100