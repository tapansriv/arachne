



select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substring(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substring(ca_zip,1,5) IN (
                          '30853','86451','80473','30329','33461','53312',
                          '76389','73039','78810','43812','75827',
                          '42601','28041','57194','90925','47758',
                          '42199','40653','78681','67813','83305',
                          '11892','33107','62302','32691','94433',
                          '87743','88689','97895','81600','91814',
                          '63291','82535','30565','82482','88823',
                          '48101','88619','90654','51432','87473',
                          '46442','41841','44135','33572','73820',
                          '63607','14294','65292','27438','17901',
                          '40466','83906','34822','67004','47969',
                          '75688','94242','68452','54050','46933',
                          '95128','47915','71618','10609','28720',
                          '87172','77256','33205','81322','17190',
                          '87685','63661','48069','10208','72068',
                          '11772','36702','35302','88241','14352',
                          '53183','75421','41673','58552','78954',
                          '76281','24675','60907','36356','96461',
                          '76416','83326','35150','86068','94076',
                          '32780','66938','79242','60391','29137',
                          '89641','57937','26043','16813','35545',
                          '69380','29563','26340','80910','60788',
                          '56624','95960','27311','18691','71310',
                          '91201','87781','31780','51326','71475',
                          '37753','41028','18013','74358','81544',
                          '97864','48831','53805','11712','70714',
                          '29073','12161','16590','42050','34404',
                          '96375','92185','48964','14567','34926',
                          '17074','85225','71407','76493','76496',
                          '47333','67365','37795','42099','63956',
                          '28363','93502','21734','68589','87987',
                          '49106','92551','29976','52560','62387',
                          '16035','72600','71793','26052','29576',
                          '11167','59508','79439','71614','83147',
                          '93870','32563','41111','58781','29752',
                          '62200','68089','78418','74718','22091',
                          '45467','15169','30953','18755','22384',
                          '67307','71210','40033','59078','21647',
                          '43402','66028','36651','79023','48494',
                          '55434','75583','12700','93120','17862',
                          '89511','16758','64636','65228','91937',
                          '68237','50532','99408','57916','19038',
                          '45378','37702','84980','69923','64186',
                          '30374','48026','76313','83199','29377',
                          '34025','64765','25871','51456','33927',
                          '56119','62672','56050','34503','26366',
                          '74929','32480','93277','46908','19236',
                          '87137','97491','84214','79958','27166',
                          '73586','23278','91129','41227','32945',
                          '81267','67755','20074','72957','62107',
                          '70815','31504','31971','81406','89733',
                          '43907','43418','76671','32273','36374',
                          '50236','63918','92631','99984','40053',
                          '67953','29867','71988','93652','77540',
                          '93961','22306','92598','56926','31250',
                          '82934','79298','61577','69228','95013',
                          '44888','82059','43129','86937','72610',
                          '49804','92492','39305','74471','68870',
                          '53722','56771','36377','60837','31355',
                          '65366','98002','46996','13124','89649',
                          '91785','60906','72765','82692','21631',
                          '83550','97542','18967','93035','78325',
                          '56459','33717','89621','89413','15457',
                          '46583','17905','97779','70343','37882',
                          '52118','31968','81358','23819','40368',
                          '86043','11070','18497','84797','85563',
                          '67340','55936','37961','58828','88816',
                          '24161','70414','88606','31200','62036',
                          '59675','60047','19097','91877','21175',
                          '35895','80695','26111','73165','29193',
                          '88351','81727','22939','68516','44055',
                          '29605','59377','73645','85513','38401',
                          '73840','24424','51738','38610','31265',
                          '86016','23673','46487','78707','33102',
                          '44250','64412','89603','70941','69068',
                          '13679','67666','16671','33669','71151',
                          '29472','81343','46424','48318','79279',
                          '18150','89021','23583','21333','96408',
                          '86824','73072','57140','36132','13740',
                          '78487','17505','62583','24574')
     intersect
      select ca_zip
      from (SELECT substring(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2002
  and (substring(s_zip,1,2) = substring(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100