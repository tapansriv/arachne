



select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substring(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substring(ca_zip,1,5) IN (
                          '80399','25526','64724','20239','75546','19776',
                          '91225','80782','53361','39077','49444',
                          '68997','68875','22435','13150','69615',
                          '63423','72289','80348','95575','75313',
                          '16159','97679','50762','21734','69807',
                          '73725','19041','53711','50722','66875',
                          '21422','12240','86181','95315','30247',
                          '51181','84038','49777','42131','34678',
                          '61648','20055','27550','13501','99454',
                          '67177','86630','99616','76044','57683',
                          '69279','37035','73005','71876','46523',
                          '75814','97133','21916','39609','59747',
                          '12121','48940','86499','82517','47916',
                          '77494','96942','66304','52566','84786',
                          '80242','62776','31295','79019','15547',
                          '25103','11960','60519','66793','20579',
                          '79196','28028','48217','83058','70482',
                          '34533','98384','75736','39733','10837',
                          '25378','59988','25586','38306','58108',
                          '93458','43821','10519','64612','79336',
                          '28266','49241','33478','83625','44746',
                          '75148','53221','94917','17614','13548',
                          '23602','29787','13332','42594','49298',
                          '72821','73423','23625','49926','58229',
                          '69891','13748','16699','72398','51501',
                          '25764','99717','60180','95174','78391',
                          '61838','37961','93399','51874','98858',
                          '16743','84934','13701','46793','21860',
                          '13789','54299','31429','48922','37691',
                          '66941','47741','56766','73601','88527',
                          '81951','39193','16987','14663','93735',
                          '10253','66687','89092','61255','33108',
                          '54386','47932','19277','83370','19249',
                          '17757','21839','52434','43327','47905',
                          '40988','13257','86148','92766','28547',
                          '38620','90844','74059','97798','51772',
                          '55835','78359','73316','69770','94061',
                          '81462','33144','49621','54488','33090',
                          '84692','81519','25720','22411','75278',
                          '17862','18825','56893','31893','24987',
                          '80248','65250','20238','88916','22965',
                          '79183','16284','76440','41316','63959',
                          '45073','80435','37342','39352','93049',
                          '78278','68349','50150','63772','25983',
                          '87875','42162','63168','50836','37647',
                          '13596','55165','27400','16165','82880',
                          '20211','21133','12001','93449','46843',
                          '90593','57311','43326','97916','38724',
                          '99114','87126','32951','27122','43794',
                          '94029','34161','99346','72987','85687',
                          '96691','22152','44242','24847','13985',
                          '40389','79371','88586','91493','63164',
                          '67643','45153','92616','98937','95871',
                          '92118','50811','84563','64047','23112',
                          '19908','47659','50998','34408','41007',
                          '80483','51235','57994','71816','75678',
                          '20240','38497','46686','28114','98947',
                          '65173','44004','61119','26376','85800',
                          '21420','70764','67516','65402','48486',
                          '82780','85752','14084','22227','51411',
                          '91409','63187','70199','16602','53458',
                          '93131','72698','99811','91214','90875',
                          '24815','33229','53637','60967','55063',
                          '25197','79436','87756','50917','54427',
                          '34288','40392','57675','48772','88022',
                          '60152','80378','49141','81684','90100',
                          '40940','69179','41268','92380','61201',
                          '77372','21794','95191','65570','85396',
                          '56864','85096','88734','23469','93213',
                          '74520','48196','56223','25135','87882',
                          '43071','72858','79470','68338','81904',
                          '71379','26249','29072','84898','68150',
                          '56339','58246','25332','43878','30399',
                          '49333','48518','69134','58867','29566',
                          '42936','44123','26257','92945','80662',
                          '68459','90972','75597','20867','16826',
                          '50070','92167','91202','29436','18302',
                          '22627','95957','17334','66506','80654',
                          '12618','67515','60378','99960','39362',
                          '18494','44877','92092','79393')
     intersect
      select ca_zip
      from (SELECT substring(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2001
  and (substring(s_zip,1,2) = substring(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100