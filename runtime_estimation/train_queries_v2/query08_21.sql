



select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substring(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substring(ca_zip,1,5) IN (
                          '73284','91925','42184','80498','24433','51387',
                          '75067','85013','36895','96300','24619',
                          '93210','39435','96480','44129','54269',
                          '72274','99011','92880','19134','62966',
                          '33989','72485','60803','67533','45935',
                          '69546','14865','36983','56090','62314',
                          '92737','16079','30688','48676','41737',
                          '49901','77588','42599','20001','77116',
                          '24197','61646','61041','44769','72783',
                          '32617','23929','57608','67273','99187',
                          '20711','76799','83558','51654','30913',
                          '78514','30287','16664','49090','78386',
                          '48338','98473','30629','79135','49693',
                          '63319','23572','31374','13255','30056',
                          '99541','64810','74200','80865','46153',
                          '69881','82359','91484','84515','46267',
                          '54233','20212','87103','24124','14622',
                          '93299','34218','93264','28454','12803',
                          '78133','67023','80527','18101','25323',
                          '90891','62297','83386','48235','84120',
                          '31099','10315','61970','86556','87330',
                          '43939','36214','45702','11441','13434',
                          '78921','32683','31270','37065','56226',
                          '11227','60420','73025','20410','22807',
                          '39066','39012','22120','51437','59430',
                          '66834','56147','54497','36913','40798',
                          '25139','41700','42412','15745','70371',
                          '39663','51674','80404','30147','36795',
                          '53024','23048','47167','74208','92385',
                          '79824','70235','94442','79414','33871',
                          '52588','68601','12248','16675','19182',
                          '85824','32832','30899','20333','11661',
                          '43082','67626','70680','23378','94267',
                          '46794','68355','52707','58363','12033',
                          '88603','72037','78869','31189','59949',
                          '14078','96004','55957','73773','82547',
                          '88706','90218','86541','95638','90610',
                          '25949','16859','27618','69792','14668',
                          '44841','99023','46229','73500','22673',
                          '74900','33789','33566','31882','84136',
                          '90454','73789','65099','66625','84979',
                          '18328','18892','13490','70585','43145',
                          '89085','40173','39831','75815','89900',
                          '74855','20684','48831','76049','52397',
                          '46814','10010','75983','66663','71668',
                          '56396','85635','43792','90961','32578',
                          '97666','88500','32059','33583','47306',
                          '76046','38060','17471','10758','82618',
                          '28995','64075','43650','24799','20358',
                          '27310','82927','49695','81438','58028',
                          '28055','68212','47908','32340','37279',
                          '70438','46329','66334','76526','80239',
                          '15159','24943','93587','49796','98750',
                          '71947','48877','49250','50997','33041',
                          '41730','16596','81844','43014','11671',
                          '94667','24139','58147','30742','21261',
                          '14284','62474','30724','31495','76054',
                          '42334','83649','22338','51670','26899',
                          '42070','68069','96967','23803','39940',
                          '10200','26664','17813','81251','29841',
                          '19313','34762','85906','84712','64779',
                          '47946','93528','31955','86692','49887',
                          '70743','94505','33498','11795','26046',
                          '34999','70549','17180','37174','47637',
                          '43136','93040','56894','37222','85968',
                          '56745','84255','59745','18883','97984',
                          '79105','48899','35707','62789','49080',
                          '61840','26612','15503','26571','50886',
                          '77232','75791','26616','81455','63769',
                          '63163','81234','23153','43143','23795',
                          '47965','90234','48866','47153','79349',
                          '24910','28883','15722','96817','90405',
                          '29127','47023','60791','34450','55683',
                          '24932','47192','15044','31020','26363',
                          '40310','97832','45676','86830','67220',
                          '42178','30695','29350','60887','88703',
                          '14094','78192','58573','34331','16199',
                          '25400','77076','82077','33002','12278',
                          '33858','21642','97996','39730','52706',
                          '75135','22113','65774','43397')
     intersect
      select ca_zip
      from (SELECT substring(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2002
  and (substring(s_zip,1,2) = substring(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100