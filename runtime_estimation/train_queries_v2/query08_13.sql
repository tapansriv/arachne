



select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substring(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substring(ca_zip,1,5) IN (
                          '93002','69972','89248','36764','71418','15772',
                          '86604','50117','45409','93230','18644',
                          '28780','31297','44697','24388','73915',
                          '16770','75939','61264','99054','80633',
                          '49302','61499','53448','96375','83018',
                          '36377','45459','57268','92549','77791',
                          '10902','26371','28090','12202','79760',
                          '86349','88691','32505','15915','83040',
                          '24244','18920','63746','45356','16510',
                          '91517','10971','51641','32110','72167',
                          '84025','69237','75366','58471','36705',
                          '49285','61040','77496','46714','65150',
                          '75594','27565','81023','49375','46792',
                          '44954','29693','69959','89102','76820',
                          '91324','79925','86783','42683','84184',
                          '90174','22637','25836','52111','84846',
                          '16773','28108','90615','40381','80365',
                          '20204','25179','93485','56362','12382',
                          '89939','63590','84830','30475','69328',
                          '22817','93167','38230','54877','58510',
                          '39597','88007','84521','64442','51665',
                          '56067','45602','43907','46812','71332',
                          '21875','71805','88771','54477','55858',
                          '43944','94629','45764','68166','18207',
                          '24466','76754','85844','82100','15860',
                          '84007','10100','58979','73478','16151',
                          '24317','63704','59425','45437','31276',
                          '52166','69855','69753','32783','13089',
                          '83873','33140','26778','37892','89229',
                          '85056','76999','56217','15921','20198',
                          '82011','34383','63929','54652','53246',
                          '31349','65249','28746','70813','18978',
                          '83629','36547','65170','17628','87943',
                          '31615','51946','94124','23542','25221',
                          '36237','66591','33225','89723','78415',
                          '77676','99851','77835','81518','79504',
                          '47465','51158','86493','68474','93021',
                          '99035','30286','39915','37252','19210',
                          '69635','98861','53723','71158','90186',
                          '73344','33262','18806','89991','25802',
                          '31639','27086','46004','76925','44512',
                          '85017','44812','88632','69057','79957',
                          '73881','71130','20046','24362','77742',
                          '69080','29168','81144','21383','56848',
                          '13722','31281','75084','77303','92231',
                          '55103','90671','84414','53395','93278',
                          '54384','51101','30437','77181','72989',
                          '74024','30222','27722','37270','14503',
                          '34028','14145','20210','71556','65874',
                          '12864','49884','31134','86490','67536',
                          '87746','80937','56544','95225','99088',
                          '23549','12417','63051','36858','10721',
                          '43833','74161','64212','57828','16361',
                          '63397','34887','25208','15701','74045',
                          '86546','92846','64282','93912','67127',
                          '74285','64883','51185','59867','14630',
                          '46615','89612','68904','21890','39310',
                          '31809','16428','63844','96446','38773',
                          '48337','21112','14217','63489','80601',
                          '86779','20706','31101','42119','65984',
                          '21194','12832','12395','34232','47932',
                          '37717','99268','92198','93341','76263',
                          '47793','45330','96676','24944','36251',
                          '52144','13643','46738','69839','34046',
                          '11853','70986','72321','43824','60784',
                          '95682','15869','63106','70471','48214',
                          '22458','56644','78808','23723','41550',
                          '39881','72676','30745','39330','88326',
                          '88605','48414','35322','36527','68796',
                          '51845','84314','79160','53162','98918',
                          '92420','94846','81454','86938','80776',
                          '21121','28012','20389','61670','35741',
                          '57741','17827','38727','53785','13303',
                          '38284','47470','48180','14896','37807',
                          '14348','51209','20376','87337','59848',
                          '57426','65631','86921','39962','60560',
                          '59177','51350','94247','36648','18205',
                          '37267','14497','76052','47169','47576',
                          '83669','29471','72055','43507','16713',
                          '72091','32996','42831','87649')
     intersect
      select ca_zip
      from (SELECT substring(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2000
  and (substring(s_zip,1,2) = substring(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100