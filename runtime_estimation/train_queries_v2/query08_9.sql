



select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substring(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substring(ca_zip,1,5) IN (
                          '19205','53683','12944','76562','36368','40987',
                          '55066','60973','71293','23356','28606',
                          '26727','69192','62457','43975','36892',
                          '86957','67543','56566','12963','49092',
                          '27295','74006','12475','26573','74095',
                          '94760','99204','50954','90420','51314',
                          '35606','29312','97558','84789','70018',
                          '62059','61566','83075','79175','20006',
                          '23375','67146','10943','53384','11657',
                          '66588','74468','12407','15428','18866',
                          '41708','73139','64815','28499','10897',
                          '60573','79193','86448','50295','50933',
                          '98930','43038','50094','72216','19728',
                          '82236','30956','80908','27077','77052',
                          '46041','56476','46974','49375','45927',
                          '90966','39597','70005','21788','99227',
                          '28224','82350','60881','51465','82572',
                          '34622','61348','21970','70306','45556',
                          '37185','13649','43744','98385','77704',
                          '84447','54782','13193','86608','34299',
                          '87707','67489','28029','26449','84777',
                          '63690','15614','43285','72668','71094',
                          '37628','94204','46829','49076','81260',
                          '70710','16243','63388','58895','88669',
                          '89182','97381','22662','98874','53049',
                          '59396','18540','52925','39574','43164',
                          '65446','77147','60494','28416','31878',
                          '65936','22593','68859','36023','14268',
                          '16713','51723','36009','64442','98160',
                          '19705','19053','98180','94922','19302',
                          '15125','62530','84386','34553','11243',
                          '91431','78684','73651','53490','12669',
                          '37853','95460','20022','18686','81342',
                          '77913','78649','48573','66336','47434',
                          '91110','31846','74726','83946','30416',
                          '99734','36700','87589','75480','39081',
                          '70546','24306','43087','81388','82996',
                          '74860','44132','36421','63546','21432',
                          '13782','59081','78863','70654','96137',
                          '43230','36332','50910','22354','52933',
                          '34373','16017','62365','99153','18792',
                          '86701','77313','22804','73922','97455',
                          '93894','99121','57162','10661','48846',
                          '76466','24869','40245','88249','79454',
                          '99955','83233','83635','44692','53765',
                          '17452','38827','54794','53806','80377',
                          '54436','82148','50308','18055','31305',
                          '56312','52247','29764','48109','16950',
                          '52306','56519','15544','15837','41571',
                          '74236','10394','29106','94146','10548',
                          '40410','60271','52688','92354','23977',
                          '65903','26415','61793','24926','97445',
                          '68693','28058','78206','52421','80091',
                          '24901','56499','54242','22238','94172',
                          '18482','42229','79646','65796','14872',
                          '96942','68943','72089','62279','10869',
                          '99956','26821','66903','11688','45768',
                          '39262','33529','90230','95820','69179',
                          '13403','15870','26350','92518','96650',
                          '76130','83519','71980','87224','30979',
                          '58840','56018','20738','19616','53176',
                          '48686','94697','35640','54365','29675',
                          '88330','79006','63761','91369','49262',
                          '38545','14276','73364','74826','77728',
                          '67953','94301','62794','45911','11322',
                          '63960','80579','99680','19427','95341',
                          '22319','83331','21587','33717','86629',
                          '43983','77630','92443','94446','84741',
                          '31024','95443','77530','47790','51864',
                          '48035','70537','79547','58631','52664',
                          '32198','32604','41680','42718','90937',
                          '55733','48546','82790','83963','39661',
                          '88107','60922','10033','35459','92480',
                          '52297','70569','36784','51301','85329',
                          '18099','25365','63788','98274','45841',
                          '13277','56438','78052','38062','13920',
                          '57478','99432','93334','34445','49713',
                          '33751','58279','87449','10834','63646',
                          '14439','89989','31691','61421','16973',
                          '68011','76396','98957','70748')
     intersect
      select ca_zip
      from (SELECT substring(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1999
  and (substring(s_zip,1,2) = substring(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100