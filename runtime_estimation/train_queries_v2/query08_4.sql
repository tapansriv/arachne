



select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substring(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substring(ca_zip,1,5) IN (
                          '18464','57904','95050','84347','30191','85009',
                          '38008','38216','73532','10584','98972',
                          '69657','24027','20156','96343','68079',
                          '25509','24704','95136','31620','69760',
                          '46220','29877','60504','88358','43067',
                          '97632','55432','56904','43928','78706',
                          '52914','98787','71135','97861','55060',
                          '40611','36140','39144','47905','16271',
                          '89847','15334','84507','72833','17646',
                          '92935','79018','71657','16772','80329',
                          '49585','19839','83326','18220','17392',
                          '84746','39075','36223','38762','98822',
                          '42597','10386','50169','57247','32761',
                          '32753','91538','12693','97614','93602',
                          '91718','87194','41145','57175','48024',
                          '60958','10138','23571','58997','23468',
                          '28124','38972','84789','48629','92932',
                          '61640','90397','90792','79444','95259',
                          '62951','25732','99233','22301','27528',
                          '22843','86169','43617','89316','65225',
                          '26452','60569','50588','81134','63529',
                          '30259','45998','36677','51826','18735',
                          '38834','43979','31827','31872','53172',
                          '54900','62114','91556','31946','81029',
                          '63440','31148','66137','31327','62690',
                          '74453','23522','42444','74963','90919',
                          '31196','98573','22883','26552','84032',
                          '45973','73202','95656','83405','76307',
                          '20099','57388','71644','88398','74766',
                          '26914','56662','10139','29707','64308',
                          '41349','37373','48029','35807','69740',
                          '13057','90111','57280','94410','41589',
                          '44317','33944','39559','40807','17163',
                          '24854','69122','45284','37915','97631',
                          '74645','21668','47387','28475','67723',
                          '86168','12578','44277','73529','25568',
                          '52281','16873','43929','66403','19359',
                          '74715','14742','42986','62867','45429',
                          '51452','46655','73711','14821','25306',
                          '44065','94414','40428','16916','63824',
                          '83673','29456','90868','56175','80350',
                          '21261','17735','26453','10191','54595',
                          '95920','97206','34405','79841','15957',
                          '82218','71392','48182','53878','58594',
                          '80431','94514','39528','38321','21795',
                          '74180','61441','92890','63067','44112',
                          '96136','30640','65996','52417','95404',
                          '67458','71533','87663','91148','84335',
                          '71183','87761','67587','89165','20818',
                          '95805','28270','35890','22763','41181',
                          '86650','94754','58836','62891','13045',
                          '55334','43285','46210','55711','19331',
                          '68556','73044','30156','88685','62875',
                          '19882','34675','73472','97851','26391',
                          '10104','83123','25132','80208','99026',
                          '35941','92186','65969','43921','10294',
                          '86954','31290','37687','32357','82734',
                          '35119','97657','56541','38849','82700',
                          '21293','70217','32383','14723','12051',
                          '12672','47987','28304','36465','31570',
                          '27788','59562','29389','89115','52487',
                          '77853','18051','48184','10598','30314',
                          '63631','96270','27812','41045','46498',
                          '12502','48707','60482','28445','44256',
                          '20472','12735','67413','37615','39185',
                          '68559','92661','23176','63962','94922',
                          '43930','19831','29581','83472','65621',
                          '48600','22351','97617','58843','35204',
                          '67969','26592','72070','13003','74014',
                          '32905','78480','13828','92115','92490',
                          '28505','45251','51501','26617','50618',
                          '38701','19290','35951','84321','62818',
                          '30386','18353','18754','87289','33681',
                          '40424','13152','82050','35067','49989',
                          '31210','16835','48689','76542','88899',
                          '55853','79002','46464','62649','12636',
                          '94139','66902','97550','59480','21881',
                          '78206','86322','43469','97683','16281',
                          '55770','89431','99157','78544','26614',
                          '55107','53761','69844','78041')
     intersect
      select ca_zip
      from (SELECT substring(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2000
  and (substring(s_zip,1,2) = substring(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100