



select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substring(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substring(ca_zip,1,5) IN (
                          '19756','60240','87780','10067','34600','88441',
                          '54224','31148','44522','30884','71426',
                          '50863','92668','20310','52243','99927',
                          '86266','92555','52242','97587','21200',
                          '18301','37388','84570','95635','66625',
                          '80100','74748','55330','85867','37634',
                          '64571','78059','36551','18706','75501',
                          '57264','50662','55242','28597','48863',
                          '45308','27727','35272','93609','65860',
                          '20205','62429','49324','61989','86398',
                          '91138','54177','49723','87037','91327',
                          '23464','60633','84856','16146','37389',
                          '56580','77073','15292','46841','92584',
                          '21937','57805','62112','31500','33195',
                          '49800','75674','29752','64337','21185',
                          '89844','10661','97230','16304','93382',
                          '15443','96752','87115','63449','45861',
                          '88918','95134','80556','48167','59152',
                          '22602','51339','46210','53230','32464',
                          '17879','41234','15979','40602','47169',
                          '23964','74637','49856','33826','18204',
                          '38909','53568','77759','51816','17417',
                          '50135','37811','88845','94647','45764',
                          '77765','60077','85842','72236','76498',
                          '85883','47834','58484','20536','28689',
                          '87719','45262','73177','46067','58607',
                          '71550','38846','22351','93488','47517',
                          '34949','73294','56941','19524','28131',
                          '79566','52580','22574','85210','68166',
                          '68688','69086','38313','72738','84876',
                          '40998','36094','33622','63053','29504',
                          '63241','28341','16481','95613','31135',
                          '67289','45445','71489','94863','33683',
                          '71390','71447','54509','28377','36254',
                          '94318','84246','93285','47167','37716',
                          '11703','17416','62339','18540','21933',
                          '35398','42911','57423','95249','64610',
                          '38448','35797','43004','29454','24462',
                          '96677','50953','47779','20439','63460',
                          '86873','45959','23795','76295','25293',
                          '28080','88469','61841','87853','33578',
                          '52986','28361','62293','21835','88100',
                          '35928','77624','63591','16012','10663',
                          '46026','14095','89082','50565','61775',
                          '23010','32637','99353','98464','77666',
                          '81018','57852','16571','61952','69217',
                          '99893','59697','22352','92934','68842',
                          '59224','24357','26938','59821','54551',
                          '77206','29765','45429','41690','77386',
                          '11036','20647','97752','18686','47208',
                          '58847','97946','84500','32512','50985',
                          '97889','66022','95951','21502','99054',
                          '12991','27807','35806','43856','26255',
                          '43197','88056','41062','77907','31528',
                          '61298','46434','32833','12161','65818',
                          '55386','43003','85584','36643','30539',
                          '99465','20591','45043','46733','27530',
                          '64785','48845','47361','62436','74358',
                          '21417','15100','13213','53679','31585',
                          '94920','88752','84103','16319','65948',
                          '45908','29240','93470','54220','22521',
                          '26370','40120','63069','85695','33885',
                          '87810','99248','10495','72541','41376',
                          '22912','57225','92831','60982','78786',
                          '21292','65004','25535','95806','16461',
                          '55336','55217','86162','22377','65740',
                          '87129','52047','67915','31106','11089',
                          '75139','89098','86073','23818','24445',
                          '44349','88961','40781','65075','94479',
                          '13290','41991','41571','66894','98723',
                          '81227','81917','82584','72848','18019',
                          '28782','83113','95161','82896','76664',
                          '38951','28587','94742','18090','87022',
                          '99861','76885','63245','98627','17758',
                          '43272','62241','63875','99766','34763',
                          '65627','68401','20571','65344','86442',
                          '83394','51875','81971','46968','90633',
                          '24846','47747','74221','25673','38630',
                          '60789','43892','77753','12198','85248',
                          '85909','22131','57794','33271')
     intersect
      select ca_zip
      from (SELECT substring(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2001
  and (substring(s_zip,1,2) = substring(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100