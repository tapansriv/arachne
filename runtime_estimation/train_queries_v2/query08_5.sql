



select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substring(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substring(ca_zip,1,5) IN (
                          '70901','18244','39862','73993','85512','67112',
                          '48501','20464','52094','33835','35473',
                          '79151','94887','18065','56348','53687',
                          '81598','36183','28850','86511','12925',
                          '35491','53691','50771','34017','52821',
                          '20819','53857','46441','30582','38997',
                          '44842','82114','40994','96295','70958',
                          '57911','27760','43214','98631','34035',
                          '12766','13866','14856','33344','79928',
                          '22039','30710','17817','84665','39311',
                          '33184','77079','63383','10609','98163',
                          '14803','33296','40446','98051','44868',
                          '62851','10531','93703','59508','75410',
                          '56014','85251','58769','32125','58855',
                          '33831','46697','15341','55836','49869',
                          '23222','39528','81201','15599','45663',
                          '53810','56105','71309','12945','47445',
                          '50793','66131','93155','63565','89961',
                          '21249','55968','82567','22768','31350',
                          '41725','50372','23841','53927','24602',
                          '19228','12013','33721','20020','71709',
                          '82718','42630','99651','93839','44682',
                          '74888','82365','33253','72948','67111',
                          '38962','76560','54634','23191','97255',
                          '24687','77286','99837','57362','27728',
                          '70915','87677','77172','98309','90326',
                          '54145','83401','75731','65804','74653',
                          '87098','18502','82745','88286','92413',
                          '31512','11462','90521','96575','61776',
                          '43991','21394','73427','77491','19142',
                          '87672','57768','40204','82439','99531',
                          '84456','85653','39584','90021','50371',
                          '77579','76181','62420','53477','18840',
                          '15791','84016','91825','81759','66460',
                          '42401','28946','34826','67353','57019',
                          '81387','56312','41257','83670','29314',
                          '80484','21703','55492','12625','72560',
                          '89450','71372','32287','81548','64751',
                          '10777','46185','36734','60745','48764',
                          '62233','63332','21699','90115','83925',
                          '12215','86418','20959','84468','76979',
                          '30443','42010','27257','12616','65379',
                          '38895','58157','95367','52412','83443',
                          '18897','18223','31078','18024','31628',
                          '49317','94806','51101','54857','95974',
                          '58381','42478','47171','20397','70797',
                          '18974','23253','58519','80301','23959',
                          '39739','68211','65587','97603','68894',
                          '40961','53392','77258','63848','23543',
                          '73047','74127','60019','70113','74206',
                          '31089','51370','15793','55333','30906',
                          '88733','56042','58470','58426','83676',
                          '39711','45520','56683','12120','87042',
                          '86315','24194','67763','16685','83420',
                          '41789','21344','96116','33768','53406',
                          '89142','27506','56648','69604','53016',
                          '14040','20240','59836','35666','76889',
                          '13852','40172','58981','74822','80808',
                          '84380','13808','52373','20926','65456',
                          '74743','64396','46078','84099','46670',
                          '41424','92505','13381','59628','86691',
                          '47844','67259','26352','34834','20902',
                          '42848','68055','74807','51157','52181',
                          '34430','79462','91103','99295','22705',
                          '77999','98646','97487','20108','48525',
                          '39131','35074','47093','93095','61643',
                          '80412','79533','51206','89293','62368',
                          '57924','88078','74391','37871','90313',
                          '22008','13916','56836','82500','95202',
                          '33711','81350','84092','14152','11522',
                          '28777','81494','31047','62508','33020',
                          '45487','77234','86618','92870','18909',
                          '20711','86444','42970','33157','55257',
                          '76769','81192','41438','12344','79902',
                          '15556','31852','24499','51248','64631',
                          '79977','25326','16657','93115','21873',
                          '27348','50418','44784','44713','36700',
                          '25470','10187','15714','25148','99044',
                          '25576','57114','94506','65329','37510',
                          '73605','36120','92456','47352')
     intersect
      select ca_zip
      from (SELECT substring(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2002
  and (substring(s_zip,1,2) = substring(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100