



select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substring(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substring(ca_zip,1,5) IN (
                          '41296','34292','77663','18562','16830','68358',
                          '44750','22913','15417','32882','15322',
                          '49829','15669','61378','99820','28846',
                          '70176','86958','50652','58731','74886',
                          '71226','23458','51233','66136','41792',
                          '65558','79605','43839','82969','87354',
                          '95635','48907','62781','42225','79099',
                          '56850','94114','24062','34383','55033',
                          '83916','43232','92890','27743','53096',
                          '15526','85138','70725','86457','49769',
                          '64257','70480','97272','67855','11507',
                          '43944','97030','20950','37048','21406',
                          '98229','91130','66080','20266','99136',
                          '13413','34697','10818','92109','16526',
                          '69703','46123','10854','80775','49623',
                          '56177','65583','95902','10744','28085',
                          '73743','28886','35689','45130','42283',
                          '70493','68082','91748','42384','97769',
                          '51639','57519','79772','49816','70568',
                          '84166','69655','70944','12579','80687',
                          '10533','11197','83324','86869','84368',
                          '75383','58648','15006','30006','56660',
                          '82612','39147','90650','50570','13751',
                          '31890','98273','66916','35020','62091',
                          '36343','35879','30290','93910','28665',
                          '27228','35134','80035','15150','98474',
                          '11759','86216','89949','64197','79245',
                          '10406','19585','72323','44252','61461',
                          '72070','19890','54511','93849','48695',
                          '91613','51060','55687','86321','26859',
                          '95498','67203','68457','77701','94242',
                          '67010','43465','62290','19897','18108',
                          '62204','77872','87184','26273','89869',
                          '34480','99160','47909','82644','20629',
                          '33300','99974','33275','13315','31150',
                          '22879','84045','10452','41409','63771',
                          '22802','71585','92313','10660','27553',
                          '52380','61899','66631','90824','33618',
                          '68087','71725','96243','91300','18348',
                          '62572','26588','36849','76761','74412',
                          '49983','96094','37100','67913','38478',
                          '69624','85725','45925','36066','52190',
                          '57231','98735','78934','71534','89938',
                          '45332','80113','34771','99150','70251',
                          '39801','93767','66456','76422','33156',
                          '84631','77647','88250','56186','67267',
                          '18610','25008','97747','24960','93841',
                          '78317','43083','15220','51573','71580',
                          '66477','87691','51881','77904','62045',
                          '48363','68014','53066','13331','17553',
                          '18682','15461','62157','59855','93204',
                          '76817','12469','26744','25075','90747',
                          '81425','79061','52113','11519','97995',
                          '70339','16007','65135','10558','19475',
                          '11841','80480','24746','60021','43504',
                          '72207','42510','48106','83804','38894',
                          '55656','82827','71159','26094','82393',
                          '95859','73187','72794','23281','25966',
                          '76661','36282','59731','12960','37410',
                          '83941','22342','74132','77682','64445',
                          '38857','83578','13778','27365','66479',
                          '79522','29405','98070','97801','12468',
                          '34589','65381','22013','45566','84838',
                          '68080','11971','98340','89188','22184',
                          '41261','93433','84004','29277','96477',
                          '66386','82373','24911','62548','85243',
                          '52494','50614','66276','29868','79214',
                          '94253','94921','29156','18506','91392',
                          '56158','86467','43512','11486','46859',
                          '95556','65990','26579','14312','76018',
                          '56754','25241','77325','73936','85008',
                          '34655','82083','90667','91912','38148',
                          '89369','39087','10690','48737','38081',
                          '40976','59900','60373','90997','29082',
                          '89004','76680','78063','48652','55939',
                          '10906','24154','97457','56446','57670',
                          '90653','13519','15241','78984','87701',
                          '13470','11328','62674','64430','53393',
                          '97358','18853','62355','20029','33294',
                          '97055','88580','78348','50791')
     intersect
      select ca_zip
      from (SELECT substring(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2002
  and (substring(s_zip,1,2) = substring(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100