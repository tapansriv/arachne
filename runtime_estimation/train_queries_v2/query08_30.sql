



select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substring(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substring(ca_zip,1,5) IN (
                          '11418','99525','42247','62247','26602','56615',
                          '64798','19727','50615','32812','12008',
                          '33002','90856','32752','27177','68298',
                          '76125','48913','92351','99922','64358',
                          '69945','12308','63765','32384','64703',
                          '63642','93197','65693','61894','26935',
                          '48404','27934','46542','71819','48110',
                          '11788','43282','85060','14019','12996',
                          '65612','55589','51006','79370','22513',
                          '13909','15294','11289','47600','42937',
                          '42532','70350','93947','93605','73877',
                          '23316','86360','13632','80619','87567',
                          '86970','50562','84330','34065','20998',
                          '71365','91912','68731','91872','76235',
                          '57317','87970','66763','59087','44299',
                          '24095','95974','77009','91466','38631',
                          '56869','12105','81184','58993','72136',
                          '92028','29989','72386','68733','94818',
                          '39339','25560','52776','76127','73182',
                          '74285','34574','11808','60155','70698',
                          '81556','48523','64356','86101','81688',
                          '63959','68995','95278','95403','59866',
                          '60735','91999','58084','64432','76805',
                          '65304','52860','60278','71534','95485',
                          '93899','11446','33003','69981','58052',
                          '81763','62829','52493','18296','35593',
                          '11867','20728','85840','45476','77431',
                          '18079','64287','40726','92274','34597',
                          '54740','73476','62499','97965','91917',
                          '33866','36705','18949','30191','30924',
                          '44628','88233','51262','40426','94238',
                          '12504','45861','71154','89512','82218',
                          '65685','18607','81481','20706','49967',
                          '74389','51608','97990','42990','59280',
                          '86760','20559','83147','34142','54808',
                          '16639','79630','15784','66070','53728',
                          '98545','25325','75264','17824','50015',
                          '30394','43551','11898','81374','91214',
                          '34856','87185','84648','71788','48792',
                          '45643','12788','29195','39565','33117',
                          '82564','56846','36608','23203','52290',
                          '44836','94375','81197','26428','78331',
                          '87205','45868','65352','83605','55182',
                          '19687','50182','88264','86394','95751',
                          '22031','64024','17955','12806','49414',
                          '14745','40610','11086','69633','28526',
                          '35331','33628','37572','94473','43215',
                          '11020','53276','85350','21594','88862',
                          '72876','17784','20534','66473','26231',
                          '51734','54709','42064','91993','57909',
                          '72215','42039','83269','17533','42688',
                          '89681','58589','92392','65957','27663',
                          '53322','55722','81221','38211','95819',
                          '48603','46155','81113','11277','27008',
                          '37238','29867','10488','97017','52070',
                          '42781','70183','37268','70221','98969',
                          '70951','79732','39724','51701','70690',
                          '48078','74824','53206','85220','76278',
                          '19517','23319','51392','24894','31220',
                          '43064','25574','93095','36385','66097',
                          '71796','59270','50787','44266','30590',
                          '24890','83199','71812','60758','66424',
                          '47956','42753','71703','26952','40639',
                          '66493','49569','88500','38851','20523',
                          '19078','72211','17583','67273','69024',
                          '85584','95711','72598','87985','51522',
                          '23145','88509','84761','89799','59908',
                          '79916','79781','16282','61632','88985',
                          '49652','60266','73375','23490','47790',
                          '78930','78157','69135','86476','30586',
                          '17999','43837','57854','31163','22503',
                          '13386','82299','84868','56266','56043',
                          '74340','55515','19049','96807','55397',
                          '43856','82534','34932','90084','69685',
                          '12668','10031','82658','95634','23746',
                          '53876','50515','45988','75540','62462',
                          '42994','75650','71609','26716','27933',
                          '60033','22106','52030','58229','79867',
                          '57531','91900','76713','89602','84949',
                          '53863','64761','55079','11172')
     intersect
      select ca_zip
      from (SELECT substring(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1999
  and (substring(s_zip,1,2) = substring(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100