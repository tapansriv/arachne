



select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substring(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substring(ca_zip,1,5) IN (
                          '11135','80957','13238','52919','43987','85186',
                          '14011','66360','76983','32784','65151',
                          '38944','67560','94440','60186','49095',
                          '86474','46476','41908','93799','63098',
                          '53974','39560','50316','92717','78436',
                          '85833','79700','81482','58926','88626',
                          '67603','19975','88957','38768','66640',
                          '71002','84290','42503','40363','11715',
                          '55266','61711','14453','99050','97524',
                          '16479','27244','69996','25202','26436',
                          '55959','84016','67957','69744','20128',
                          '58026','10787','95142','51681','10600',
                          '39024','81483','99952','46245','56920',
                          '94977','17889','74726','10487','47088',
                          '90546','83317','66143','84940','69616',
                          '54856','12553','18807','21488','87346',
                          '11785','29143','23685','31875','32317',
                          '50334','15832','27129','17790','54348',
                          '40501','55117','76620','31362','46133',
                          '78187','52975','71856','20388','20060',
                          '97826','56396','74332','21146','72795',
                          '91757','83294','71099','88846','25744',
                          '32357','63848','68800','63871','94954',
                          '12752','43045','26207','55402','58674',
                          '83337','39863','60068','51722','31725',
                          '73031','76391','43239','46635','73078',
                          '71466','43157','78773','60102','40216',
                          '92668','83736','47177','49727','85371',
                          '38885','80258','35034','52361','71191',
                          '57280','29607','44048','48903','68463',
                          '23641','76721','57594','27152','38606',
                          '48622','40071','95393','71128','51560',
                          '72723','41743','93937','92725','42254',
                          '90892','50758','57390','75693','99930',
                          '99326','64402','78007','72372','40061',
                          '59491','19653','72953','90654','69821',
                          '69778','96676','34681','15202','78945',
                          '22717','79316','71781','33403','47713',
                          '23033','39204','18061','37244','35469',
                          '94214','90301','99575','13839','11895',
                          '69673','48417','89423','36267','14037',
                          '36592','72300','93757','22395','59379',
                          '13399','69986','62655','46598','13229',
                          '34404','32515','99001','37986','42172',
                          '27192','60799','52956','68802','90799',
                          '50012','39059','55192','93855','50113',
                          '52667','31330','93187','65051','22936',
                          '49285','14799','66972','29009','95830',
                          '82541','93064','38467','51206','29103',
                          '33950','25430','85727','93260','96064',
                          '41502','41093','78551','19038','32851',
                          '19651','83270','61101','81291','20087',
                          '73117','63395','28552','10005','97931',
                          '84185','91942','16891','73920','86730',
                          '13797','54073','19329','39825','57078',
                          '12497','37204','17624','87507','54672',
                          '30104','58873','99684','82538','17112',
                          '46039','44811','33157','13813','46426',
                          '18526','19542','45942','15033','96263',
                          '53933','33522','34257','52362','17179',
                          '57470','91473','69084','26941','16064',
                          '30968','69095','47262','16964','40968',
                          '37609','87937','38397','91143','23516',
                          '48787','57727','71183','99668','78276',
                          '31386','42855','77946','42792','31416',
                          '89278','82101','92687','28877','35321',
                          '65747','87446','65979','62609','22907',
                          '13469','67892','91621','63354','80477',
                          '98063','26496','57882','73844','93401',
                          '34012','45733','61568','37391','77409',
                          '22749','39853','60815','56905','59362',
                          '30864','40394','31321','17057','35918',
                          '72803','46059','94394','40458','68148',
                          '33493','15469','64452','80797','47848',
                          '92270','48276','46992','23912','27534',
                          '98850','27590','18704','72828','51038',
                          '59088','97065','95706','15011','87037',
                          '75633','87501','45319','86237','10225',
                          '73429','57033','66982','29172','80978',
                          '79547','17153','90059','75616')
     intersect
      select ca_zip
      from (SELECT substring(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1998
  and (substring(s_zip,1,2) = substring(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100