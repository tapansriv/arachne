



select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substring(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substring(ca_zip,1,5) IN (
                          '11906','45226','19740','76922','85405','56531',
                          '90533','26382','25447','75753','64323',
                          '92364','12897','98347','53695','95916',
                          '52918','80598','84991','33098','16209',
                          '73885','71203','42024','89102','37256',
                          '33830','37569','65482','16282','78863',
                          '15089','80582','95111','70125','47297',
                          '71829','57397','82333','93050','94144',
                          '65395','33287','71899','53634','65200',
                          '78857','40917','70302','31806','21527',
                          '33895','94996','19747','68497','14093',
                          '59141','22341','29228','11723','32744',
                          '84917','95082','98729','10041','64380',
                          '46799','42962','51507','91309','19570',
                          '95667','46292','70924','84243','76554',
                          '83064','17031','68338','20671','33515',
                          '51949','68333','38791','10335','71506',
                          '65044','75714','62534','37994','96546',
                          '23098','74144','13292','68212','44494',
                          '17167','14644','34727','90399','43558',
                          '43927','84913','99555','48921','64730',
                          '49527','56788','34467','38966','99307',
                          '35740','50747','10640','56161','38107',
                          '29097','92541','90694','75490','31474',
                          '77694','12899','86254','90001','39866',
                          '27988','85733','28529','23369','76978',
                          '80965','53936','11302','58898','55177',
                          '82680','40105','91685','84723','12670',
                          '49638','47941','17364','71622','38064',
                          '15460','83550','93917','76326','66626',
                          '57007','65416','94342','56211','26672',
                          '63055','59282','94583','42158','64176',
                          '36870','47002','12311','80856','38734',
                          '53658','83002','47922','62546','56054',
                          '69706','86205','53016','43020','93684',
                          '55036','41357','23194','96997','61071',
                          '57034','57789','69361','67912','66553',
                          '76874','28068','99951','10649','57423',
                          '42719','34642','42442','26233','60058',
                          '33116','97362','42445','60166','47519',
                          '96511','82892','77946','57677','22527',
                          '31073','43215','33546','56746','72789',
                          '54991','31946','54295','66120','27981',
                          '17018','35205','66251','56204','89108',
                          '38194','25894','25956','73570','41018',
                          '50597','94464','16696','60526','92417',
                          '45129','53847','97948','60212','61849',
                          '99876','54883','85071','65991','87040',
                          '96774','87306','35501','99344','31057',
                          '13173','13502','56992','96703','38757',
                          '88820','20099','93100','50551','31544',
                          '47338','83888','74751','97878','12477',
                          '42458','24607','44743','92141','32196',
                          '71089','44644','28222','46794','57269',
                          '98910','71107','64090','55828','42344',
                          '35254','99849','26213','42258','44672',
                          '30646','52718','34482','75791','53826',
                          '67279','18457','71991','34109','20674',
                          '76958','79930','62177','24856','14427',
                          '99568','16620','34847','45390','86161',
                          '80029','89457','76897','40057','66986',
                          '71591','96410','56573','83307','29603',
                          '89822','60536','27999','60910','75809',
                          '31249','49433','24313','81848','13871',
                          '10972','46861','99397','90928','27227',
                          '87389','10735','69945','36806','40072',
                          '37153','87974','41060','47382','59166',
                          '26861','69299','26228','49661','79446',
                          '40211','24881','81061','91900','19833',
                          '76309','33276','51500','82488','20871',
                          '72834','52328','73486','11804','54082',
                          '24457','26211','22044','18486','81194',
                          '18450','86896','34465','63599','38574',
                          '24730','62915','25143','37443','31518',
                          '12497','11356','92107','95675','26434',
                          '53464','67158','67858','73771','84990',
                          '36291','83314','49974','96477','26617',
                          '49008','34156','56995','88163','79502',
                          '67832','17248','28665','70077','31204',
                          '28049','30348','84740','29696')
     intersect
      select ca_zip
      from (SELECT substring(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 1998
  and (substring(s_zip,1,2) = substring(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100