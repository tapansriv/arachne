



select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substring(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substring(ca_zip,1,5) IN (
                          '48021','34520','28162','75626','75118','70297',
                          '10949','96743','44689','77981','27043',
                          '51571','87430','51882','82656','49305',
                          '53072','52993','58635','52543','65370',
                          '82128','67238','61006','65836','34971',
                          '57690','53135','20050','74025','34443',
                          '41868','32175','42073','26019','81300',
                          '15290','31617','59385','15479','73076',
                          '81113','77947','15622','48117','73080',
                          '17469','62428','32495','76432','20538',
                          '32653','92971','85246','21683','52877',
                          '88355','78512','47599','70895','10662',
                          '77804','17501','92888','68248','71322',
                          '74763','64722','77919','95102','80134',
                          '61811','97049','74963','19814','84060',
                          '38057','79320','84273','51101','61021',
                          '63409','49613','55734','48333','36624',
                          '66194','74066','49219','78787','79985',
                          '45659','43027','14198','54726','18259',
                          '83340','61591','30218','68269','86451',
                          '80700','93135','33196','92238','33595',
                          '61328','74628','69355','34632','25022',
                          '76963','79999','79772','30491','87834',
                          '96390','38055','53479','29004','95229',
                          '63666','40234','54249','66328','24437',
                          '26353','20313','54024','78345','80129',
                          '88118','26387','94669','52668','56651',
                          '72070','28575','23898','30887','95883',
                          '14376','67605','85105','14728','98779',
                          '25395','64211','79119','13859','13867',
                          '36878','94647','30366','40144','98994',
                          '58320','55982','57057','55950','97461',
                          '61508','45485','61691','78406','69729',
                          '41426','56338','48419','18405','53587',
                          '84105','62218','20974','38361','52579',
                          '53471','52690','49900','15218','42500',
                          '11572','88404','19227','11652','83162',
                          '86179','40378','97555','58402','15751',
                          '60545','82632','67753','70099','62345',
                          '91891','42987','43406','52333','31809',
                          '27550','64170','14691','49949','13681',
                          '13829','56679','34304','34614','14031',
                          '15303','75576','62018','34861','92980',
                          '87224','41841','63219','55751','59528',
                          '76932','10300','99640','68961','49753',
                          '12337','25866','19346','77437','78443',
                          '99568','65044','32938','78997','86380',
                          '65088','58137','64014','84646','30444',
                          '54155','79830','20224','44072','52150',
                          '91986','90080','40433','60712','25146',
                          '86700','15233','20280','42519','38855',
                          '48237','59184','58898','56628','51350',
                          '35881','95735','37988','89991','68484',
                          '55006','56906','15948','82238','28562',
                          '48477','88077','64811','19967','79060',
                          '60237','36881','85885','89620','16473',
                          '13828','40867','19564','81519','19047',
                          '23184','79990','67637','76325','41903',
                          '77186','21160','80687','60779','21625',
                          '62267','67946','66527','51258','69822',
                          '62691','25974','82378','19268','67032',
                          '13973','93227','45961','43039','15178',
                          '36550','85914','51893','99684','72076',
                          '49275','86758','47454','80151','89928',
                          '86199','71911','66980','34745','26434',
                          '84829','95389','76329','37445','20486',
                          '88791','29866','48194','17665','83898',
                          '84681','86042','93913','31387','24889',
                          '86774','30804','13377','18744','87855',
                          '96068','63863','15349','33066','92670',
                          '33057','18082','40181','16571','43754',
                          '64488','56761','43831','75141','31139',
                          '42031','52217','74557','90393','56361',
                          '16459','69704','44241','58573','62890',
                          '53876','51160','34337','94253','17845',
                          '73262','51205','10739','82565','23494',
                          '95445','21214','54019','33788','78000',
                          '12562','40635','57971','58787','47463',
                          '49861','82853','21083','58028','34338',
                          '78017','11512','45729','80575')
     intersect
      select ca_zip
      from (SELECT substring(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2002
  and (substring(s_zip,1,2) = substring(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100