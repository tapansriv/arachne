



select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substring(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substring(ca_zip,1,5) IN (
                          '53126','66484','35703','12076','32903','87591',
                          '91066','83982','14218','24683','75412',
                          '13071','75065','47196','61783','88670',
                          '33427','32391','51107','55650','13120',
                          '43264','75026','65589','27649','67432',
                          '19693','96649','70265','54014','63790',
                          '73180','12862','60545','30013','68697',
                          '13996','99022','43094','81655','24096',
                          '35536','15308','74613','41400','77689',
                          '51856','10008','42773','85427','95372',
                          '58747','86972','94339','26616','74022',
                          '38267','28997','60701','31742','99692',
                          '93380','86471','77131','81749','56286',
                          '62554','83078','19122','92982','51333',
                          '64083','48105','65543','97500','88308',
                          '91222','47185','67612','80691','82206',
                          '45230','28624','38811','12997','76893',
                          '30749','75897','44780','81138','97733',
                          '13234','91695','24259','14773','58858',
                          '41019','39928','32862','78436','77526',
                          '89828','11792','52620','57991','39208',
                          '21176','18801','31277','14282','30731',
                          '60938','83337','24075','99028','87330',
                          '80615','23843','28979','10350','61803',
                          '68596','22263','26798','62195','11900',
                          '16473','22690','90352','29379','21353',
                          '81477','66044','66763','21808','98383',
                          '94978','10333','71366','83686','66920',
                          '34514','70712','69955','76973','55451',
                          '85540','63627','56429','69809','23330',
                          '92079','38291','16624','71230','20441',
                          '65428','34158','43879','89044','58362',
                          '20130','92229','19683','56265','61267',
                          '84417','54879','65300','20990','81890',
                          '36784','46358','30911','60387','83449',
                          '67865','15855','23958','68831','96536',
                          '87897','30471','71903','95430','99431',
                          '58870','52662','41911','43600','14583',
                          '13388','86938','65596','32498','15463',
                          '99108','84864','46317','53276','10891',
                          '88254','61076','52252','50148','41766',
                          '68496','27921','85847','45125','72581',
                          '22924','22914','47772','71587','91595',
                          '54056','77934','48463','20926','45734',
                          '69049','47865','82354','10762','68434',
                          '25073','76344','13293','18297','64708',
                          '35610','79432','27677','52511','87624',
                          '30216','24300','30826','54809','37363',
                          '68190','31312','36625','83593','53037',
                          '40149','99368','89409','13458','75322',
                          '72135','22390','38792','59851','82779',
                          '37030','62555','21747','97995','39625',
                          '68484','40775','45160','95139','90420',
                          '68309','33747','94155','60726','55594',
                          '10684','80527','99645','81587','55559',
                          '48291','97560','90011','69173','72465',
                          '54844','95840','80975','57901','76211',
                          '98520','78780','95901','48814','52611',
                          '69107','58177','86578','69984','12002',
                          '81497','81436','17098','36556','21830',
                          '18452','61521','58980','84390','52184',
                          '88367','43631','21420','68335','17284',
                          '15313','20051','31345','90701','28897',
                          '25391','93174','76185','14721','48762',
                          '43373','97958','84541','30195','19241',
                          '43432','37970','74535','78053','39074',
                          '33382','99294','59451','12091','42709',
                          '63468','48442','51314','79676','37208',
                          '14980','53797','90124','44828','33273',
                          '35764','16680','16279','93831','41423',
                          '64113','91957','70462','14857','49426',
                          '10681','11338','45276','90333','67535',
                          '62390','85788','39277','57855','66504',
                          '31494','34831','77699','92859','87457',
                          '36967','69586','91841','95940','68257',
                          '13511','83014','67375','55229','90916',
                          '25927','24856','54207','12493','19713',
                          '61790','18620','52248','82957','36553',
                          '10434','20573','46430','53890','88638',
                          '96587','65714','64926','13786')
     intersect
      select ca_zip
      from (SELECT substring(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2002
  and (substring(s_zip,1,2) = substring(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100