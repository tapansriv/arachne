



select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substring(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substring(ca_zip,1,5) IN (
                          '23566','50337','35560','92864','52909','92267',
                          '52500','12179','69011','13989','11482',
                          '93328','60551','44059','97312','99708',
                          '18700','90240','36803','58698','13594',
                          '55838','66106','21052','26983','58689',
                          '50832','90671','40034','94628','31352',
                          '20698','36074','34044','24935','79626',
                          '22504','27622','99772','42593','38747',
                          '65021','81540','65887','63586','94519',
                          '90994','22158','65455','46960','50223',
                          '40674','84648','72482','46487','25152',
                          '65525','78642','51210','78222','50343',
                          '45856','20127','38784','35378','61085',
                          '63966','25992','96433','73056','37811',
                          '32108','33375','69673','38789','90339',
                          '67739','78279','34343','40623','52259',
                          '62557','87784','75406','77129','25436',
                          '38878','70033','17795','42274','94631',
                          '71658','56577','41634','76585','89891',
                          '18686','77216','42476','80971','16898',
                          '90001','16537','89404','37750','21377',
                          '97229','34732','82217','43063','63349',
                          '15050','40108','57717','41824','74897',
                          '72117','62628','29899','29891','99739',
                          '65905','18667','41518','22946','85879',
                          '74707','24245','13338','29192','17051',
                          '95170','27114','98902','55313','88733',
                          '17007','60925','59835','97351','28466',
                          '95892','57943','94435','24050','84855',
                          '67155','98571','85543','15621','97972',
                          '74846','41959','81586','97387','81237',
                          '81751','41223','65447','97694','16344',
                          '18480','24297','40238','39661','43096',
                          '26772','26689','27864','45925','63681',
                          '73912','89871','26488','62659','62710',
                          '38342','37888','52866','93047','67281',
                          '78331','18788','89378','47455','61412',
                          '23387','15104','52595','58447','47909',
                          '69023','24630','15905','92915','56527',
                          '22025','34383','18090','19820','57540',
                          '63422','13413','82678','86359','24572',
                          '82851','33204','46198','69588','42550',
                          '91126','40355','60665','18359','38388',
                          '64567','90631','12548','37728','25194',
                          '37206','76432','96706','16852','56754',
                          '47856','25035','83561','45716','74393',
                          '54570','47499','74073','55506','98391',
                          '27761','19678','10126','25060','61590',
                          '91660','44057','22833','40733','30755',
                          '62660','83837','35989','29631','55945',
                          '95537','95159','94658','54564','89307',
                          '97018','29674','99242','41979','32069',
                          '88712','18439','21097','31304','86994',
                          '25110','31195','46078','57024','28427',
                          '76634','21822','96432','13987','40609',
                          '84325','65401','23473','28452','22103',
                          '18187','11971','23793','42809','47284',
                          '56346','82470','29345','67647','94082',
                          '32715','70142','45379','44553','33197',
                          '53679','22163','86900','19217','55572',
                          '86760','59002','28433','38804','48698',
                          '34839','88669','85663','80828','57519',
                          '49561','64737','76123','45073','28009',
                          '61094','62020','90985','64701','91341',
                          '65217','40008','66581','12006','84600',
                          '62733','20494','90966','45793','94758',
                          '32195','81477','17889','86654','36251',
                          '15154','79291','57290','58271','34515',
                          '64049','85502','22907','94566','83470',
                          '66212','10425','59466','36046','36135',
                          '91397','31854','83801','58259','77565',
                          '44207','78479','48166','36799','49884',
                          '43496','23162','40693','51607','77892',
                          '39253','88191','10325','74182','55849',
                          '64778','19489','23796','90853','59991',
                          '18273','74055','70197','45104','84550',
                          '66326','89746','20856','91928','90871',
                          '21787','22200','40878','96963','16553',
                          '42146','71411','40808','62673','88627',
                          '81483','73761','30979','95927')
     intersect
      select ca_zip
      from (SELECT substring(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2001
  and (substring(s_zip,1,2) = substring(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100