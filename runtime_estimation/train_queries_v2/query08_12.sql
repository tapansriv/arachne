



select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substring(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substring(ca_zip,1,5) IN (
                          '48751','70935','17354','80958','48614','33137',
                          '66905','75780','33945','61340','89186',
                          '98805','44157','87053','67360','49456',
                          '56833','17163','63672','38512','35590',
                          '95668','41958','72439','82455','17250',
                          '48521','20892','10635','66966','94789',
                          '86185','24668','97461','64670','71318',
                          '74121','87072','78684','74510','50710',
                          '60209','87336','90430','85936','48732',
                          '23475','37001','43255','96685','32640',
                          '24595','24318','50002','99665','77847',
                          '30609','63005','98334','23923','14294',
                          '56367','25255','79313','87230','81543',
                          '79763','33110','35833','68745','15763',
                          '32930','38234','25606','43879','81394',
                          '69167','81039','26621','41143','73579',
                          '37491','64268','96130','86956','38300',
                          '11618','44783','72278','99337','94063',
                          '11647','81675','13308','71345','67091',
                          '52758','73763','67389','37602','76448',
                          '86367','95367','79970','60076','94216',
                          '51165','18742','19909','22341','70879',
                          '62298','32048','53458','42862','68570',
                          '33721','89173','15154','54124','21456',
                          '71415','46830','13756','85222','49332',
                          '80335','16745','17087','64865','84120',
                          '81615','38038','62127','92310','68024',
                          '22347','11790','69823','22135','35290',
                          '45720','20490','39476','96951','42482',
                          '74305','87349','53020','69811','59339',
                          '92684','89904','56810','29641','67715',
                          '28979','21056','60659','71742','55487',
                          '96555','21626','93417','68386','10120',
                          '22259','63345','27731','58790','67160',
                          '79939','20495','66673','44986','71587',
                          '92051','25769','30839','36622','70074',
                          '53785','43167','67961','68160','49446',
                          '34325','30655','70752','81239','11776',
                          '10974','86545','76123','44420','12803',
                          '47730','32493','44764','38035','53697',
                          '61524','24454','14079','98452','10046',
                          '52585','20618','93823','56306','10141',
                          '42602','35190','62940','28651','74706',
                          '31660','73603','57418','11488','55576',
                          '53690','63619','61969','26739','96178',
                          '39951','29081','97167','20481','17585',
                          '90579','50616','33458','79376','53643',
                          '92531','25628','24557','75988','90483',
                          '36942','92870','53811','29549','74037',
                          '30522','40837','65847','60563','28841',
                          '95683','24093','82215','93895','72108',
                          '18722','59865','22545','54118','63380',
                          '29769','82322','32168','88736','51622',
                          '98342','36006','89079','95838','89624',
                          '46669','54610','10682','86033','48513',
                          '40231','92998','94892','39117','87576',
                          '90613','73092','69613','18074','50091',
                          '67964','82558','63411','84556','45034',
                          '58498','49302','47037','76179','48023',
                          '41293','78781','94111','20311','13401',
                          '10340','81612','81506','76223','39455',
                          '85926','21477','44260','24161','27064',
                          '87326','71301','65854','86381','19241',
                          '44763','58541','15206','98904','29653',
                          '81648','25509','43997','13105','11208',
                          '47686','53048','53080','63604','95325',
                          '34415','82188','53033','44809','13156',
                          '68589','44600','32075','20782','79600',
                          '63997','94733','17539','84378','41831',
                          '98508','64819','40146','95041','44917',
                          '94885','19836','71603','98862','60087',
                          '58898','66266','84828','75777','63564',
                          '49836','27955','51272','78418','44345',
                          '40243','83421','91159','69699','83931',
                          '24192','54656','86063','46773','84086',
                          '89887','95990','82001','52510','76899',
                          '56309','48980','14190','11419','68407',
                          '30993','20538','78944','16424','83468',
                          '63167','96662','64456','16599','57685',
                          '53851','35497','89971','24032')
     intersect
      select ca_zip
      from (SELECT substring(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1998
  and (substring(s_zip,1,2) = substring(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100