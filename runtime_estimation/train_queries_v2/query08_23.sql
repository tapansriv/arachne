



select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substring(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substring(ca_zip,1,5) IN (
                          '87910','68819','29383','79178','28622','88621',
                          '20387','98199','81634','81545','29577',
                          '19670','61286','80970','33751','10272',
                          '85099','79104','44763','54368','91676',
                          '92713','69497','15820','40629','71753',
                          '48532','24135','82853','75475','24761',
                          '19814','90859','11370','50967','75626',
                          '89414','71962','61960','61381','36010',
                          '54194','69533','78754','39329','59204',
                          '98196','48251','35815','89699','70378',
                          '19409','65398','26943','42828','26313',
                          '26988','58298','88203','60115','91931',
                          '73691','29303','93810','94987','30840',
                          '66824','43459','67044','13034','19553',
                          '78405','23230','19912','46085','50507',
                          '96547','88045','85498','35604','46492',
                          '74427','53325','10911','36221','23390',
                          '29197','94255','16431','11177','11482',
                          '53467','88735','81519','78099','22133',
                          '22427','63781','17833','32264','89338',
                          '16733','23908','84430','20980','58521',
                          '18885','78691','68802','97114','32981',
                          '73742','53388','48925','30709','52313',
                          '38544','37613','17557','16091','84346',
                          '30412','42820','12483','49521','26864',
                          '27459','15796','36382','66322','24387',
                          '14623','30177','33007','65381','99533',
                          '75243','95499','51082','13377','37725',
                          '39248','85084','45899','64727','83171',
                          '55309','10702','52191','96999','40562',
                          '64545','38628','51215','60849','53012',
                          '19664','13239','93205','74414','50641',
                          '85361','39175','54192','90173','75496',
                          '88135','64706','74864','42519','80030',
                          '74078','11511','88345','24370','53663',
                          '95148','19682','91792','60789','67888',
                          '39710','30145','48954','17662','74814',
                          '49719','39787','59171','43701','42727',
                          '34344','91627','35356','62076','61477',
                          '26143','47684','51700','29988','74467',
                          '75381','75540','32278','72358','73775',
                          '72802','51828','50627','28669','21548',
                          '73485','38624','64339','50891','15706',
                          '14883','73475','75675','99538','43477',
                          '71658','61356','76416','50672','82774',
                          '44485','47119','21529','87085','20770',
                          '29956','47915','46391','83862','15228',
                          '54409','37952','25588','66096','93824',
                          '86535','98554','10717','38573','63146',
                          '72044','76226','76899','15970','30464',
                          '71604','93901','62160','44612','23542',
                          '51894','30343','42150','44509','79621',
                          '69159','52385','50219','16704','70101',
                          '99472','71027','99470','51107','99856',
                          '36017','52210','97462','79212','97408',
                          '33820','60762','82024','76301','73294',
                          '88185','86993','50297','50209','76609',
                          '17967','21970','88695','39949','69265',
                          '96775','68844','37531','63939','37690',
                          '26929','67610','55841','24498','21431',
                          '52582','97573','74080','51961','96970',
                          '55987','66859','92822','67397','61288',
                          '13032','54299','46574','73333','18668',
                          '19525','18622','91751','78064','15049',
                          '41215','80906','55334','36255','93871',
                          '26443','68557','64667','32842','75943',
                          '57807','54026','62850','37155','95971',
                          '38840','78242','72488','40936','44970',
                          '61137','78251','48380','95059','47095',
                          '41345','10786','60257','75253','56525',
                          '57489','80572','67117','94235','88068',
                          '50082','18756','90518','55051','86527',
                          '64894','97865','57039','71116','79796',
                          '69423','38147','61749','16366','12455',
                          '76735','58579','83507','82589','30887',
                          '63635','81885','72591','15930','30549',
                          '79782','60901','92019','64453','42455',
                          '67822','26750','31491','57929','18899',
                          '49453','94362','94906','32950','52649',
                          '79217','37190','39553','89307')
     intersect
      select ca_zip
      from (SELECT substring(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 1998
  and (substring(s_zip,1,2) = substring(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100