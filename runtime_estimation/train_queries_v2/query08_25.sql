



select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substring(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substring(ca_zip,1,5) IN (
                          '37211','43597','42066','77574','56871','45454',
                          '69418','86559','81643','81340','34908',
                          '72123','16932','87728','78865','42035',
                          '47618','34812','78278','57334','39811',
                          '72783','25827','70288','15465','89135',
                          '76999','48535','47757','84679','84979',
                          '60712','76928','14154','23718','62173',
                          '92069','91827','50058','91912','35011',
                          '90309','25291','73199','16893','54577',
                          '60165','12111','34038','50053','84581',
                          '70025','34460','76235','39860','87326',
                          '64327','53904','35858','90177','61306',
                          '94409','74003','59984','66123','26700',
                          '93251','83027','12762','47884','65598',
                          '79300','60981','48233','84182','82849',
                          '16389','60273','39119','70328','29871',
                          '81723','82063','64249','37870','73021',
                          '98996','22965','36734','65099','81882',
                          '90370','14262','33092','26954','61387',
                          '99405','80499','59585','69916','52002',
                          '66112','72165','13959','38146','70334',
                          '88912','55581','72347','30854','40199',
                          '62207','98040','40855','93869','25560',
                          '19905','21583','44306','18856','23636',
                          '61873','34697','12380','49327','18297',
                          '42859','65390','22622','89819','45161',
                          '47341','75886','15378','22384','64128',
                          '58867','64188','44925','42068','58929',
                          '63236','43120','77552','28676','68204',
                          '66352','51139','59729','19767','10959',
                          '73251','64037','26902','22750','84454',
                          '25178','25771','64458','91298','74410',
                          '33125','23000','91130','96266','57719',
                          '91822','26185','17660','66337','50712',
                          '63027','23070','14373','96122','60812',
                          '99941','73451','55442','67927','54733',
                          '35404','24025','89569','64377','53067',
                          '40988','79175','87732','37830','17817',
                          '61280','86189','15702','81942','55293',
                          '84256','69920','10670','22929','77091',
                          '14516','28183','66539','36082','63437',
                          '20894','36121','26395','79272','90008',
                          '12096','35829','79523','11080','46053',
                          '10881','95925','37295','17186','67478',
                          '33116','94772','51452','74060','34874',
                          '69748','44703','41819','19506','18462',
                          '60658','69880','86639','87917','27573',
                          '29163','62991','85586','88169','16485',
                          '35116','36159','42549','68420','13206',
                          '90602','87678','61906','85831','47934',
                          '65415','98322','84648','57951','77455',
                          '30837','74033','40777','59492','65330',
                          '54552','56549','87114','43690','65594',
                          '70586','65651','52775','52663','83994',
                          '30700','48262','29741','91482','50389',
                          '65820','53955','93822','90382','16801',
                          '61211','59213','50805','72991','25011',
                          '77513','54477','60558','35300','63560',
                          '93080','83424','58458','92480','86492',
                          '41837','64191','68923','61610','38666',
                          '12430','25239','39834','58809','22456',
                          '43002','90010','11943','46360','14640',
                          '77664','36165','63537','41995','23610',
                          '68250','57247','71727','21640','46083',
                          '85721','76197','27034','42527','32041',
                          '41450','45714','75577','83165','34204',
                          '89835','19675','77164','24798','99471',
                          '96330','54854','35498','23515','47023',
                          '53076','88497','79890','99109','76605',
                          '41429','38100','63683','82285','29347',
                          '34104','81445','57669','69121','20818',
                          '47588','31832','46487','37705','39638',
                          '70199','72188','29008','84166','40845',
                          '68912','96731','44656','90061','77501',
                          '76440','97786','74749','61273','44930',
                          '76991','89523','49058','88372','58800',
                          '78151','12600','65896','22861','13377',
                          '93877','29886','33842','33363','85002',
                          '71891','45077','68569','83630','95866',
                          '78423','90572','23929','57090')
     intersect
      select ca_zip
      from (SELECT substring(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 1 and d_year = 2002
  and (substring(s_zip,1,2) = substring(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100